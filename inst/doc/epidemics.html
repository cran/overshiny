<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Tutorial: Overlays for interventions in epidemic modelling</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Tutorial: Overlays for interventions in
epidemic modelling</h1>



<p>This tutorial will walk you through how to use <code>overshiny</code>
to add interactive overlays to epidemic curves generated by an
infectious disease transmission model to explore the effect of different
interventions like vaccines and social distancing. This is the use case
that originally spurred the development of <code>overshiny</code> as an
offshoot of an infectious disease modelling Shiny app developed at the
London School of Hygiene and Tropical Medicine during the COVID-19
pandemic.</p>
<p>This tutorial doesn’t assume any previous knowledge of
<code>shiny</code> or <code>overshiny</code>, but is not a comprehensive
introduction to <code>shiny</code>. We will be using the package
<code>epidemics</code> to provide the actual infectious disease model
underlying the simulation.</p>
<div id="epidemic-simulation" class="section level1">
<h1>Epidemic simulation</h1>
<p>OK, let’s begin. If you’re developing a <code>shiny</code> app based
around some relatively complex simulation code, it often helps to start
by putting the simulation code together outside the context of a
<code>shiny</code> app, and later building the app to include it. That
helps you catch errors with the simulation code before putting it into
an app, which often makes it harder to catch errors. So let’s start with
our infectious disease model in <code>epidemics</code> and move on to
the <code>shiny</code> app later on.</p>
<p>First, make sure you have the <code>epidemics</code> package
installed, and the most recent version of <code>overshiny</code> (the
version on CRAN is not recent enough for this tutorial!):</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;epiverse-trace/epidemics&quot;</span>)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;nicholasdavies/overshiny&quot;</span>)</span></code></pre></div>
<p>Now, let’s build a simple function that will produce a simulation run
from <code>epidemics</code> and return the results.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">library</span>(epidemics)</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="co"># Model run function</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>run_model <span class="ot">&lt;-</span> <span class="cf">function</span>()</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>{</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>    <span class="co"># Build parameters</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>    I0 <span class="ot">&lt;-</span> <span class="fl">0.001</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>    pop_size <span class="ot">&lt;-</span> <span class="dv">1000000</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>    </span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>    <span class="co"># Build population</span></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>    pop <span class="ot">&lt;-</span> <span class="fu">population</span>(</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>        <span class="at">name =</span> <span class="st">&quot;Utopia&quot;</span>,</span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>        <span class="at">contact_matrix =</span> <span class="fu">matrix</span>(<span class="dv">1</span>),</span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>        <span class="at">demography_vector =</span> <span class="dv">1000000</span>,</span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>        <span class="at">initial_conditions =</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span> <span class="sc">-</span> I0, <span class="dv">0</span>, I0, <span class="dv">0</span>, <span class="dv">0</span>), <span class="at">nrow =</span> <span class="dv">1</span>)</span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a>    )</span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a>    <span class="co"># Run model</span></span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">model_default</span>(pop)</span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a>    <span class="fu">return</span> (results)</span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a>}</span></code></pre></div>
<p>Note that <code>I0</code> is the initial proportion of infectious
individuals, and <code>pop_size</code> is the total population size.
Test this function out and see if you can plot the prevalence of
infection (compartment <code>&quot;infectious&quot;</code>) before continuing.</p>
<details>
<summary>
Click for one possible answer…
</summary>
<p>Here’s how you might do it using <code>ggplot2</code>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">run_model</span>()</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>results <span class="ot">&lt;-</span> results[results<span class="sc">$</span>compartment <span class="sc">==</span> <span class="st">&quot;infectious&quot;</span>, ]</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="fu">ggplot</span>(results) <span class="sc">+</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">&quot;Infection prevalence&quot;</span>)</span></code></pre></div>
<p>You should see an exponentially growing epidemic (with a little dip
at the start).</p>
</details>
<div id="connecting-to-a-mock-up-of-input" class="section level2">
<h2>Connecting to a mock-up of <code>input</code></h2>
<p>At the moment, our <code>run_model()</code> function produces an
epidemic curve based on some default parameters. We want
<code>run_model()</code> to respond to user input, though, so that users
of our app can provide parameters like the basic reproduction number
<i>R</i><sub>0</sub>, the infectious period, the duration of the
epidemic, and so on.</p>
<p>Within <code>shiny</code>, user input is provided in a list<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> called
<code>input</code>. So let’s say that the <code>input</code> list
contains the following:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>input <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>    <span class="co"># Start and end dates of the epidemic</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    <span class="at">date_range =</span> <span class="fu">as.Date</span>(<span class="fu">c</span>(<span class="st">&quot;2025-01-01&quot;</span>, <span class="st">&quot;2025-12-31&quot;</span>)),</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    <span class="co"># Population size in millions</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>    <span class="at">pop_size =</span> <span class="dv">59</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>    <span class="co"># Percentage (not proportion) of the population initially infected</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>    <span class="at">init_infec =</span> <span class="fl">0.1</span>,</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>    <span class="co"># Duration of latent period in days</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>    <span class="at">latent_pd =</span> <span class="dv">2</span>,</span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>    <span class="co"># Duration of infectious period in days</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>    <span class="at">infec_pd =</span> <span class="dv">7</span>,</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>    <span class="co"># Basic reproduction number</span></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>    <span class="at">R0 =</span> <span class="fl">1.3</span>,</span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>)</span></code></pre></div>
<p>Note that in the above, we have specified lots of the parameters in
“natural” units – the population size is in millions, the initial
proportion of infected people is in percent (not a proportion), and we
specify an infectious period in days rather than a recovery rate in
days<sup>-1</sup>. Also, rather than specifying a total duration for the
epidemic in days, we have specified a start date and end date for the
epidemic. This is because we’re going to develop our Shiny app with end
users in mind, and they may not be used to the more mathematically
tractable units that infectious disease modellers use.</p>
<p>By looking at the documentation for
<code>epidemics::population()</code> and
<code>epidemics::model_default()</code>, can you rewrite the
<code>run_model()</code> function so that it sets all the relevant
parameters from the <code>input</code> list above? Rewrite it so that
<code>input</code> is passed as an argument to
<code>run_model()</code>.</p>
<details>
<summary>
Click for one possible answer…
</summary>
<p>Here’s how you might do it:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># Model run function</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>run_model <span class="ot">&lt;-</span> <span class="cf">function</span>(input)</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>{</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>    <span class="co"># Transform parameters</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>    I0 <span class="ot">&lt;-</span> input<span class="sc">$</span>init_infec <span class="sc">/</span> <span class="dv">100</span>; <span class="co"># Percent to proportion</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>    duration <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(input<span class="sc">$</span>date_range[<span class="dv">2</span>] <span class="sc">-</span> input<span class="sc">$</span>date_range[<span class="dv">1</span>]) <span class="co"># Dates to duration</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>    infec_rate <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> input<span class="sc">$</span>latent_pd <span class="co"># Latent period to infectiousness rate</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>    recov_rate <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> input<span class="sc">$</span>infec_pd  <span class="co"># Infectious period to recovery rate</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>    trans_rate <span class="ot">&lt;-</span> input<span class="sc">$</span>R0 <span class="sc">*</span> recov_rate <span class="co"># R0 to transmission rate (R_0 = beta / gamma)</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>    <span class="co"># Build population</span></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>    pop <span class="ot">&lt;-</span> <span class="fu">population</span>(</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>        <span class="at">name =</span> <span class="st">&quot;Utopia&quot;</span>,</span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>        <span class="at">contact_matrix =</span> <span class="fu">matrix</span>(<span class="dv">1</span>),</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>        <span class="at">demography_vector =</span> input<span class="sc">$</span>pop_size <span class="sc">*</span> <span class="dv">1000000</span>, <span class="co"># Population size in millions</span></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>        <span class="at">initial_conditions =</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span> <span class="sc">-</span> I0, <span class="dv">0</span>, I0, <span class="dv">0</span>, <span class="dv">0</span>), <span class="at">nrow =</span> <span class="dv">1</span>)</span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>    )</span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>    <span class="co"># Run model</span></span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">model_default</span>(pop, <span class="at">transmission_rate =</span> trans_rate,</span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>        <span class="at">infectiousness_rate =</span> infec_rate, <span class="at">recovery_rate =</span> recov_rate,</span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>        <span class="at">time_end =</span> duration)</span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a>    <span class="fu">return</span> (results)</span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a>}</span></code></pre></div>
</details>
<p>Once you’ve done this, check that you’re happy with the results
before moving on.</p>
</div>
</div>
<div id="shiny-app-skeleton" class="section level1">
<h1>Shiny app skeleton</h1>
<p>Now, let’s set our simulation code aside and put together a basic
<code>shiny</code> app.</p>
<p>All <code>shiny</code> apps have two parts. The first part is a
<code>ui</code> (user interface), which determines how the app is laid
out. This is where you define all the components of the app, where they
are, and what they look like. The second part is a <code>server</code>
function, which is where the processing happens. The server is where you
transform all the user inputs into outputs, and do any calculations that
need to respond to user input.</p>
<p>Let’s start with a really basic skeleton for our <code>shiny</code>
app. This can go in a new <code>.R</code> script file, but don’t get rid
of your old code from the last section as we’ll put it back in
later.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="fu">library</span>(epidemics)</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="fu">library</span>(shiny)</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="co"># --- User interface ---</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>ui <span class="ot">&lt;-</span> <span class="fu">fluidPage</span>(</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>    <span class="fu">titlePanel</span>(<span class="st">&quot;SEIRV model with interventions&quot;</span>),</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>    <span class="co"># 3 columns of inputs</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>    <span class="fu">fluidRow</span>(</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">4</span>,</span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>            <span class="co"># Basic epidemic settings</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>            <span class="fu">h3</span>(<span class="st">&quot;Epidemic&quot;</span>)</span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>        ),</span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">4</span>,</span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>            <span class="co"># Pathogen settings</span></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>            <span class="fu">h3</span>(<span class="st">&quot;Pathogen&quot;</span>)</span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>        ),</span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">4</span>,</span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a>            <span class="co"># Intervention settings</span></span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a>            <span class="fu">h3</span>(<span class="st">&quot;Interventions&quot;</span>)</span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a>        )</span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a>    )</span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a>)</span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a><span class="co"># --- App logic ---</span></span>
<span id="cb6-28"><a href="#cb6-28" tabindex="-1"></a>server <span class="ot">&lt;-</span> <span class="cf">function</span>(input, output)</span>
<span id="cb6-29"><a href="#cb6-29" tabindex="-1"></a>{</span>
<span id="cb6-30"><a href="#cb6-30" tabindex="-1"></a>}</span>
<span id="cb6-31"><a href="#cb6-31" tabindex="-1"></a></span>
<span id="cb6-32"><a href="#cb6-32" tabindex="-1"></a><span class="co"># --- Run app ---</span></span>
<span id="cb6-33"><a href="#cb6-33" tabindex="-1"></a><span class="fu">shinyApp</span>(ui, server)</span></code></pre></div>
<p>Put all that in a script and run it. You should see a window pop up
with a big title that says “SEIRV model with interventions”, and three
smaller titles underneath.</p>
<p>Even though this is a very basic app, there’s a lot to unpick here.
In particular, the large part of the script that generates the user
interface has a lot going on. Let’s take it step by step.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co"># --- User interface ---</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>ui <span class="ot">&lt;-</span> <span class="fu">fluidPage</span>(</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>    ...</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>)</span></code></pre></div>
<p>In <code>shiny</code>, the user interface is constructed of nested
function calls. This mirrors the nested structure of a web page – so
e.g. here the <code>fluidPage</code> contains several elements, which
themselves may contain several other elements. <code>fluidPage</code> is
just one option for the top-level element; others include
<code>fixedPage</code> or <code>basicPage</code>. <code>fluidPage</code>
is a flexible layout that can dynamically rearrange the elements if
someone is using your app on a smaller screen, like on a mobile phone,
so it’s handy to use.</p>
<p>To make use of this dynamic rearrangement, a <code>fluidPage</code>
is divided into rows, which are defined using the <code>shiny</code>
function <code>fluidRow</code>. In turn, each <code>fluidRow</code> is
divided into columns (with the <code>shiny</code> function
<code>column</code>). Each <code>column</code> within a
<code>fluidRow</code> has a width, and the width of all the columns in a
row together should add up to 12. (In a <code>fluidRow</code>, columns
can only have whole-number widths.) They chose 12 as the total width of
a row because it divides well into 1, 2, 3, 4, or 6 columns. On a
computer screen, normally you will see the <code>fluidRow</code> all in
one actual row, but if you are looking at your Shiny app on a smaller
screen, like on a phone, you might see your <code>fluidRow</code> broken
up across multiple actual rows.</p>
<p>As an example, if your <code>shiny</code> ui contains:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="fu">fluidRow</span>(</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>    <span class="fu">column</span>(<span class="dv">4</span>, <span class="st">&quot;part one&quot;</span>),</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>    <span class="fu">column</span>(<span class="dv">4</span>, <span class="st">&quot;part two&quot;</span>),</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>    <span class="fu">column</span>(<span class="dv">4</span>, <span class="st">&quot;part three&quot;</span>)</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>)</span></code></pre></div>
<p>then on a larger screen, you would see something like</p>
<pre>part one     part two    part three  </pre>
<p>while on a phone, you might see</p>
<pre>part one
part two
part three</pre>
<p>Arranging each part vertically on a small screen instead of
horizontally helps ensure that your content don’t get too hard to see on
a mobile device because it’s all squished into one row, which is
especially helpful if the columns contain plots or other more complex
elements.</p>
<p>So, looking again at our whole UI definition:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co"># --- User interface ---</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>ui <span class="ot">&lt;-</span> <span class="fu">fluidPage</span>(</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>    <span class="fu">titlePanel</span>(<span class="st">&quot;SEIRV model with interventions&quot;</span>),</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>    <span class="co"># 3 columns of inputs</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>    <span class="fu">fluidRow</span>(</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">4</span>,</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>            <span class="co"># Basic epidemic settings</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>            <span class="fu">h3</span>(<span class="st">&quot;Epidemic&quot;</span>)</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>        ),</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">4</span>,</span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>            <span class="co"># Pathogen settings</span></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>            <span class="fu">h3</span>(<span class="st">&quot;Pathogen&quot;</span>)</span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>        ),</span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">4</span>,</span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>            <span class="co"># Intervention settings</span></span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a>            <span class="fu">h3</span>(<span class="st">&quot;Interventions&quot;</span>)</span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a>        )</span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a>    )</span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a>)</span></code></pre></div>
<p>This defines a <code>fluidPage</code>. There is a
<code>titlePanel</code> at the top; anything not explicitly in a
<code>fluidRow</code> takes up a whole row, so the title panel appears
on its own row. Then there is a <code>fluidRow</code>, which by
definition has a total “width” of 12 units. It contains three
<code>column</code>s each of size 4 (to add up to 12); the size of the
column is the first parameter to <code>column</code> and then all the
elements that should appear in the column are subsequent arguments.</p>
<p>Here, each column contains a header <code>h3</code> with some text.
In HTML, <code>h1</code> through <code>h6</code> define headers for
sections, where <code>h1</code> is the biggest and <code>h6</code> is
the smallest. You don’t need to start at <code>h1</code> and work your
way down, and often people select header levels (<code>h1</code> through
<code>h6</code>) based on aesthetics (i.e. which size looks right)
rather than a strict logical ordering. We’ve gone based on aesthetics
here; we could have used <code>h1</code> instead of <code>h3</code> but
I think it looks too big (try it and see for yourself!). To be clear,
there’s no relationship between the header level and the column
size.</p>
<div id="adding-input-widgets" class="section level2">
<h2>Adding input widgets</h2>
<p>Now we’ll edit our Shiny app skeleton to have some more interesting
things going on. Take a look at the code below. We have added new
elements to the three columns we had before. After you’ve looked at
these, run this entire following script:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="fu">library</span>(epidemics)</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="fu">library</span>(shiny)</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="co"># --- User interface ---</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>ui <span class="ot">&lt;-</span> <span class="fu">fluidPage</span>(</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>    <span class="fu">titlePanel</span>(<span class="st">&quot;SEIRV model with interventions&quot;</span>),</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>    <span class="co"># 3 columns of inputs</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>    <span class="fu">fluidRow</span>(</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">4</span>,</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>            <span class="co"># Basic epidemic settings</span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>            <span class="fu">h3</span>(<span class="st">&quot;Epidemic&quot;</span>),</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>            <span class="fu">dateRangeInput</span>(<span class="st">&quot;date_range&quot;</span>, <span class="st">&quot;Date range&quot;</span>, <span class="at">start =</span> <span class="st">&quot;2025-01-01&quot;</span>, <span class="at">end =</span> <span class="st">&quot;2025-12-31&quot;</span>),</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>            <span class="fu">numericInput</span>(<span class="st">&quot;pop_size&quot;</span>, <span class="st">&quot;Population size (millions)&quot;</span>, <span class="at">value =</span> <span class="dv">59</span>, <span class="at">min =</span> <span class="dv">1</span>),</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">&quot;init_infec&quot;</span>, <span class="st">&quot;Initial proportion infectious (%)&quot;</span>, <span class="at">value =</span> <span class="fl">0.1</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>, <span class="at">step =</span> <span class="fl">0.01</span>)</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>        ),</span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">4</span>,</span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>            <span class="co"># Pathogen settings</span></span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a>            <span class="fu">h3</span>(<span class="st">&quot;Pathogen&quot;</span>),</span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">&quot;R0&quot;</span>, <span class="fu">HTML</span>(<span class="st">&quot;Basic reproduction number, &lt;i&gt;R&lt;/i&gt;&lt;sub&gt;0&lt;/sub&gt;&quot;</span>),</span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a>                <span class="at">value =</span> <span class="fl">1.3</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">5</span>, <span class="at">step =</span> <span class="fl">0.05</span>),</span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">&quot;latent_pd&quot;</span>, <span class="st">&quot;Latent period (days)&quot;</span>, <span class="at">value =</span> <span class="dv">2</span>, <span class="at">min =</span> <span class="dv">1</span>, <span class="at">max =</span> <span class="dv">7</span>, <span class="at">step =</span> <span class="fl">0.1</span>),</span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">&quot;infec_pd&quot;</span>, <span class="st">&quot;Infectious period (days)&quot;</span>, <span class="at">value =</span> <span class="dv">7</span>, <span class="at">min =</span> <span class="dv">1</span>, <span class="at">max =</span> <span class="dv">10</span>, <span class="at">step =</span> <span class="fl">0.1</span>)</span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a>        ),</span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a></span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">4</span>,</span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a>            <span class="co"># Overlay controls: tokens that can be dragged onto the plot</span></span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a>            <span class="fu">h3</span>(<span class="st">&quot;Interventions&quot;</span>)</span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a>        )</span>
<span id="cb10-31"><a href="#cb10-31" tabindex="-1"></a>    )</span>
<span id="cb10-32"><a href="#cb10-32" tabindex="-1"></a>)</span>
<span id="cb10-33"><a href="#cb10-33" tabindex="-1"></a></span>
<span id="cb10-34"><a href="#cb10-34" tabindex="-1"></a><span class="co"># --- App logic ---</span></span>
<span id="cb10-35"><a href="#cb10-35" tabindex="-1"></a>server <span class="ot">&lt;-</span> <span class="cf">function</span>(input, output)</span>
<span id="cb10-36"><a href="#cb10-36" tabindex="-1"></a>{</span>
<span id="cb10-37"><a href="#cb10-37" tabindex="-1"></a>}</span>
<span id="cb10-38"><a href="#cb10-38" tabindex="-1"></a></span>
<span id="cb10-39"><a href="#cb10-39" tabindex="-1"></a><span class="co"># --- Run app ---</span></span>
<span id="cb10-40"><a href="#cb10-40" tabindex="-1"></a><span class="fu">shinyApp</span>(ui, server)</span></code></pre></div>
<p>Now we’re getting somewhere! We’ve added some input widgets to the
first two columns. <code>shiny</code> gives us
<code>dateRangeInput()</code> to put in a range of dates (you can use
<code>dateInput()</code> for just one date); <code>numericInput()</code>
to enter a number using an input box (or <code>textInput()</code> for
free text input); and <code>sliderInput()</code> to enter a number using
a slider–plus many more options. All of the input “widgets” provided by
<code>shiny</code> are called <code>[something]Input()</code> and they
follow some common conventions: the first argument is a special ID which
we’ll use later, the second argument is a label to show next to the
input, and then the other inputs define things like the starting value
or the minimum and maximum. For more information, consult the
<code>shiny</code> manual with e.g. <code>?sliderInput</code>.</p>
</div>
</div>
<div id="combining-inputs-and-outputs" class="section level1">
<h1>Combining inputs and outputs</h1>
<p>Now what we want to do is combine our previous
<code>run_model()</code> function with these <code>shiny</code> inputs
so that the inputs connect to the model. Also, we want to plot the
results of the model. Let’s do that now.</p>
<p>First, in a new file, paste in your <code>run_model()</code> function
from before with the calls to <code>library</code> that we need. Nothing
here is new:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="fu">library</span>(shiny)</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="fu">library</span>(epidemics)</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="co"># Model run function</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>run_model <span class="ot">&lt;-</span> <span class="cf">function</span>(input)</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>{</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>    <span class="co"># Transform parameters</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>    I0 <span class="ot">&lt;-</span> input<span class="sc">$</span>init_infec <span class="sc">/</span> <span class="dv">100</span>; <span class="co"># Percent to proportion</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>    duration <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(input<span class="sc">$</span>date_range[<span class="dv">2</span>] <span class="sc">-</span> input<span class="sc">$</span>date_range[<span class="dv">1</span>]) <span class="co"># Dates to duration</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>    infec_rate <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> input<span class="sc">$</span>latent_pd <span class="co"># Latent period to infectiousness rate</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>    recov_rate <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> input<span class="sc">$</span>infec_pd  <span class="co"># Infectious period to recovery rate</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>    trans_rate <span class="ot">&lt;-</span> input<span class="sc">$</span>R0 <span class="sc">*</span> recov_rate <span class="co"># R0 to transmission rate (R_0 = beta / gamma)</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>    <span class="co"># Build population</span></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>    pop <span class="ot">&lt;-</span> <span class="fu">population</span>(</span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>        <span class="at">name =</span> <span class="st">&quot;Utopia&quot;</span>,</span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>        <span class="at">contact_matrix =</span> <span class="fu">matrix</span>(<span class="dv">1</span>),</span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>        <span class="at">demography_vector =</span> input<span class="sc">$</span>pop_size <span class="sc">*</span> <span class="dv">1000000</span>, <span class="co"># Population size in millions</span></span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>        <span class="at">initial_conditions =</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span> <span class="sc">-</span> I0, <span class="dv">0</span>, I0, <span class="dv">0</span>, <span class="dv">0</span>), <span class="at">nrow =</span> <span class="dv">1</span>)</span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a>    )</span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a>    <span class="co"># Run model</span></span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">model_default</span>(pop, <span class="at">transmission_rate =</span> trans_rate,</span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a>        <span class="at">infectiousness_rate =</span> infec_rate, <span class="at">recovery_rate =</span> recov_rate,</span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a>        <span class="at">time_end =</span> duration)</span>
<span id="cb11-27"><a href="#cb11-27" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" tabindex="-1"></a>    <span class="fu">return</span> (results)</span>
<span id="cb11-29"><a href="#cb11-29" tabindex="-1"></a>}</span></code></pre></div>
<p>Underneath that, let’s put in our user interface from before, with
one addition:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co"># --- User interface ---</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>ui <span class="ot">&lt;-</span> <span class="fu">fluidPage</span>(</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>    <span class="fu">titlePanel</span>(<span class="st">&quot;SEIRV model with interventions&quot;</span>),</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>    </span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>    <span class="co"># NEW PART IS HERE:</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>    <span class="co"># Main plot</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>    <span class="fu">plotOutput</span>(<span class="st">&quot;display&quot;</span>, <span class="at">width =</span> <span class="st">&quot;100%&quot;</span>, <span class="at">height =</span> <span class="dv">400</span>),</span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>    <span class="co"># </span><span class="re">END</span><span class="co"> OF NEW PART</span></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>    <span class="co"># 3 columns of inputs</span></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>    <span class="fu">fluidRow</span>(</span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">4</span>,</span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a>            <span class="co"># Basic epidemic settings</span></span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a>            <span class="fu">h3</span>(<span class="st">&quot;Epidemic&quot;</span>),</span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a>            <span class="fu">dateRangeInput</span>(<span class="st">&quot;date_range&quot;</span>, <span class="st">&quot;Date range&quot;</span>, <span class="at">start =</span> <span class="st">&quot;2025-01-01&quot;</span>, <span class="at">end =</span> <span class="st">&quot;2025-12-31&quot;</span>),</span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a>            <span class="fu">numericInput</span>(<span class="st">&quot;pop_size&quot;</span>, <span class="st">&quot;Population size (millions)&quot;</span>, <span class="at">value =</span> <span class="dv">59</span>, <span class="at">min =</span> <span class="dv">1</span>),</span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">&quot;init_infec&quot;</span>, <span class="st">&quot;Initial proportion infectious (%)&quot;</span>, <span class="at">value =</span> <span class="fl">0.1</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>, <span class="at">step =</span> <span class="fl">0.01</span>)</span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a>        ),</span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">4</span>,</span>
<span id="cb12-21"><a href="#cb12-21" tabindex="-1"></a>            <span class="co"># Pathogen settings</span></span>
<span id="cb12-22"><a href="#cb12-22" tabindex="-1"></a>            <span class="fu">h3</span>(<span class="st">&quot;Pathogen&quot;</span>),</span>
<span id="cb12-23"><a href="#cb12-23" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">&quot;R0&quot;</span>, <span class="fu">HTML</span>(<span class="st">&quot;Basic reproduction number, &lt;i&gt;R&lt;/i&gt;&lt;sub&gt;0&lt;/sub&gt;&quot;</span>),</span>
<span id="cb12-24"><a href="#cb12-24" tabindex="-1"></a>                <span class="at">value =</span> <span class="fl">1.3</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">5</span>, <span class="at">step =</span> <span class="fl">0.05</span>),</span>
<span id="cb12-25"><a href="#cb12-25" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">&quot;latent_pd&quot;</span>, <span class="st">&quot;Latent period (days)&quot;</span>, <span class="at">value =</span> <span class="dv">2</span>, <span class="at">min =</span> <span class="dv">1</span>, <span class="at">max =</span> <span class="dv">7</span>, <span class="at">step =</span> <span class="fl">0.1</span>),</span>
<span id="cb12-26"><a href="#cb12-26" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">&quot;infec_pd&quot;</span>, <span class="st">&quot;Infectious period (days)&quot;</span>, <span class="at">value =</span> <span class="dv">7</span>, <span class="at">min =</span> <span class="dv">1</span>, <span class="at">max =</span> <span class="dv">10</span>, <span class="at">step =</span> <span class="fl">0.1</span>)</span>
<span id="cb12-27"><a href="#cb12-27" tabindex="-1"></a>        ),</span>
<span id="cb12-28"><a href="#cb12-28" tabindex="-1"></a></span>
<span id="cb12-29"><a href="#cb12-29" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">4</span>,</span>
<span id="cb12-30"><a href="#cb12-30" tabindex="-1"></a>            <span class="co"># Overlay controls: tokens that can be dragged onto the plot</span></span>
<span id="cb12-31"><a href="#cb12-31" tabindex="-1"></a>            <span class="fu">h3</span>(<span class="st">&quot;Interventions&quot;</span>)</span>
<span id="cb12-32"><a href="#cb12-32" tabindex="-1"></a>        )</span>
<span id="cb12-33"><a href="#cb12-33" tabindex="-1"></a>    )</span>
<span id="cb12-34"><a href="#cb12-34" tabindex="-1"></a>)</span></code></pre></div>
<p>The bit we added was a <code>plotOutput</code> call, which puts space
in the app for a plot (either <code>ggplot2</code> or base R plot) with
the ID <code>&quot;display&quot;</code>. To connect this plot with the inputs, we
need to add some code to our <code>server</code> function, so put this
code underneath what you have already:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co"># --- App logic ---</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>server <span class="ot">&lt;-</span> <span class="cf">function</span>(input, output)</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>{</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>    output<span class="sc">$</span>display <span class="ot">&lt;-</span> <span class="fu">renderPlot</span>({</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>        results <span class="ot">&lt;-</span> <span class="fu">run_model</span>(input)</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>        results <span class="ot">&lt;-</span> results[results<span class="sc">$</span>compartment <span class="sc">==</span> <span class="st">&quot;infectious&quot;</span>, ]</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>        <span class="fu">ggplot</span>(results) <span class="sc">+</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>            <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>            <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">&quot;Infection prevalence&quot;</span>) <span class="sc">+</span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>            <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="cn">NA</span>)</span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>    })</span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>}</span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a><span class="co"># --- Run app ---</span></span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a><span class="fu">shinyApp</span>(ui, server)</span></code></pre></div>
<p>If you put all this together, you should have a working model that
connects to the user input, where the epidemic curve changes depending
on how you manipulate the various input controls.</p>
<p>That handful of lines in <code>server</code> is doing a lot. First,
note that we’re calling the <code>shiny</code> function
<code>renderPlot</code>, and assigning the value to
<code>output$display</code>. The reason <code>output$display</code>
exists is because we put a <code>plotOutput</code> in the
<code>shiny</code> UI with ID <code>&quot;display&quot;</code> – this makes an
entry in <code>output</code> called <code>display</code> which is ready
to receive a plot from the server function. If in our UI, we had given
our <code>plotOutput</code> a different ID, like:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>    <span class="fu">plotOutput</span>(<span class="st">&quot;marmite&quot;</span>, <span class="at">width =</span> <span class="st">&quot;100%&quot;</span>, <span class="at">height =</span> <span class="dv">400</span>),</span></code></pre></div>
<p>then we would have to assign the results of a call to
<code>renderPlot()</code> to <code>output$marmite</code>.</p>
<p>Within <code>renderPlot()</code>, the first argument is a bit of R
code (in curly braces, <code>{}</code>) that should return a ggplot2
plot, or produce a base R plot. Finally, note that we are now passing
the <code>shiny</code> input object <code>input</code> to
<code>run_model()</code>. <code>run_model()</code> is expecting
<code>input</code> to contain values named <code>date_range</code>,
<code>R0</code>, and so on; because we have made all those input widgets
in out UI above, <code>input</code> automatically contains the values
that have been entered.</p>
<p>OK. Before continuing, let’s tidy up the output a little. First of
all, the y-axis of the plot extends up into the millions, and numbers
like “1e+06” are a little tough to interpret. Try changing the plotting
code in the <code>server</code> function so that the plot y-axis is in
thousands, and this is indicated on the y-axis label.</p>
<p>Second, the x-axis is currently in days from 0 to the duration of the
epidemic, but we are providing our <code>shiny</code> app with specific
dates. Try making the x-axis show calendar dates instead of the number
of days from the beginning of the epidemic. (Hint: you can use the
<code>input</code> list here.)</p>
<details>
<summary>
Click for one possible answer…
</summary>
<p>Here’s how you might make these changes to the <code>server</code>
function just by changing the call to <code>ggplot</code>:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="fu">ggplot</span>(results) <span class="sc">+</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time <span class="sc">+</span> input<span class="sc">$</span>date_range[<span class="dv">1</span>], <span class="at">y =</span> value <span class="sc">/</span> <span class="dv">1000</span>)) <span class="sc">+</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">&quot;Infection prevalence (thousands)&quot;</span>) <span class="sc">+</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="cn">NA</span>)</span></code></pre></div>
</details>
</div>
<div id="adding-interventions-with-overshiny" class="section level1">
<h1>Adding interventions with <code>overshiny</code></h1>
<p>In the last part of this tutorial, let’s finally connect our
<code>shiny</code> app with <code>overshiny</code> so that we can deploy
interventions such as social distancing and vaccination on our
infectious disease transmission model. We’re not going to get into the
fine details of how specifically to model these interventions; this is
more just to demonstrate how <code>overshiny</code> works in the context
of the model we’ve developed.</p>
<p>Starting from the code we developed in the last section:</p>
<details>
<summary>
Click for starter code…
</summary>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="fu">library</span>(shiny)</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="fu">library</span>(epidemics)</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="co"># Model run function</span></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>run_model <span class="ot">&lt;-</span> <span class="cf">function</span>(input)</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>{</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>    <span class="co"># Transform parameters</span></span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a>    I0 <span class="ot">&lt;-</span> input<span class="sc">$</span>init_infec <span class="sc">/</span> <span class="dv">100</span>; <span class="co"># Percent to proportion</span></span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a>    duration <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(input<span class="sc">$</span>date_range[<span class="dv">2</span>] <span class="sc">-</span> input<span class="sc">$</span>date_range[<span class="dv">1</span>]) <span class="co"># Dates to duration</span></span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a>    infec_rate <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> input<span class="sc">$</span>latent_pd <span class="co"># Latent period to infectiousness rate</span></span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a>    recov_rate <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> input<span class="sc">$</span>infec_pd  <span class="co"># Infectious period to recovery rate</span></span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a>    trans_rate <span class="ot">&lt;-</span> input<span class="sc">$</span>R0 <span class="sc">*</span> recov_rate <span class="co"># R0 to transmission rate (R_0 = beta / gamma)</span></span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a>    <span class="co"># Build population</span></span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a>    pop <span class="ot">&lt;-</span> <span class="fu">population</span>(</span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a>        <span class="at">name =</span> <span class="st">&quot;Utopia&quot;</span>,</span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a>        <span class="at">contact_matrix =</span> <span class="fu">matrix</span>(<span class="dv">1</span>),</span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a>        <span class="at">demography_vector =</span> input<span class="sc">$</span>pop_size <span class="sc">*</span> <span class="dv">1000000</span>, <span class="co"># Population size in millions</span></span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a>        <span class="at">initial_conditions =</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span> <span class="sc">-</span> I0, <span class="dv">0</span>, I0, <span class="dv">0</span>, <span class="dv">0</span>), <span class="at">nrow =</span> <span class="dv">1</span>)</span>
<span id="cb16-21"><a href="#cb16-21" tabindex="-1"></a>    )</span>
<span id="cb16-22"><a href="#cb16-22" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" tabindex="-1"></a>    <span class="co"># Run model</span></span>
<span id="cb16-24"><a href="#cb16-24" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">model_default</span>(pop, <span class="at">transmission_rate =</span> trans_rate,</span>
<span id="cb16-25"><a href="#cb16-25" tabindex="-1"></a>        <span class="at">infectiousness_rate =</span> infec_rate, <span class="at">recovery_rate =</span> recov_rate,</span>
<span id="cb16-26"><a href="#cb16-26" tabindex="-1"></a>        <span class="at">time_end =</span> duration)</span>
<span id="cb16-27"><a href="#cb16-27" tabindex="-1"></a></span>
<span id="cb16-28"><a href="#cb16-28" tabindex="-1"></a>    <span class="fu">return</span> (results)</span>
<span id="cb16-29"><a href="#cb16-29" tabindex="-1"></a>}</span>
<span id="cb16-30"><a href="#cb16-30" tabindex="-1"></a></span>
<span id="cb16-31"><a href="#cb16-31" tabindex="-1"></a><span class="co"># --- User interface ---</span></span>
<span id="cb16-32"><a href="#cb16-32" tabindex="-1"></a>ui <span class="ot">&lt;-</span> <span class="fu">fluidPage</span>(</span>
<span id="cb16-33"><a href="#cb16-33" tabindex="-1"></a>    <span class="fu">titlePanel</span>(<span class="st">&quot;SEIRV model with interventions&quot;</span>),</span>
<span id="cb16-34"><a href="#cb16-34" tabindex="-1"></a>    </span>
<span id="cb16-35"><a href="#cb16-35" tabindex="-1"></a>    <span class="co"># NEW PART IS HERE:</span></span>
<span id="cb16-36"><a href="#cb16-36" tabindex="-1"></a>    <span class="co"># Main plot</span></span>
<span id="cb16-37"><a href="#cb16-37" tabindex="-1"></a>    <span class="fu">plotOutput</span>(<span class="st">&quot;display&quot;</span>, <span class="at">width =</span> <span class="st">&quot;100%&quot;</span>, <span class="at">height =</span> <span class="dv">400</span>),</span>
<span id="cb16-38"><a href="#cb16-38" tabindex="-1"></a>    <span class="co"># </span><span class="re">END</span><span class="co"> OF NEW PART</span></span>
<span id="cb16-39"><a href="#cb16-39" tabindex="-1"></a></span>
<span id="cb16-40"><a href="#cb16-40" tabindex="-1"></a>    <span class="co"># 3 columns of inputs</span></span>
<span id="cb16-41"><a href="#cb16-41" tabindex="-1"></a>    <span class="fu">fluidRow</span>(</span>
<span id="cb16-42"><a href="#cb16-42" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">4</span>,</span>
<span id="cb16-43"><a href="#cb16-43" tabindex="-1"></a>            <span class="co"># Basic epidemic settings</span></span>
<span id="cb16-44"><a href="#cb16-44" tabindex="-1"></a>            <span class="fu">h3</span>(<span class="st">&quot;Epidemic&quot;</span>),</span>
<span id="cb16-45"><a href="#cb16-45" tabindex="-1"></a>            <span class="fu">dateRangeInput</span>(<span class="st">&quot;date_range&quot;</span>, <span class="st">&quot;Date range&quot;</span>, <span class="at">start =</span> <span class="st">&quot;2025-01-01&quot;</span>, <span class="at">end =</span> <span class="st">&quot;2025-12-31&quot;</span>),</span>
<span id="cb16-46"><a href="#cb16-46" tabindex="-1"></a>            <span class="fu">numericInput</span>(<span class="st">&quot;pop_size&quot;</span>, <span class="st">&quot;Population size (millions)&quot;</span>, <span class="at">value =</span> <span class="dv">59</span>, <span class="at">min =</span> <span class="dv">1</span>),</span>
<span id="cb16-47"><a href="#cb16-47" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">&quot;init_infec&quot;</span>, <span class="st">&quot;Initial proportion infectious (%)&quot;</span>, <span class="at">value =</span> <span class="fl">0.1</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>, <span class="at">step =</span> <span class="fl">0.01</span>)</span>
<span id="cb16-48"><a href="#cb16-48" tabindex="-1"></a>        ),</span>
<span id="cb16-49"><a href="#cb16-49" tabindex="-1"></a></span>
<span id="cb16-50"><a href="#cb16-50" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">4</span>,</span>
<span id="cb16-51"><a href="#cb16-51" tabindex="-1"></a>            <span class="co"># Pathogen settings</span></span>
<span id="cb16-52"><a href="#cb16-52" tabindex="-1"></a>            <span class="fu">h3</span>(<span class="st">&quot;Pathogen&quot;</span>),</span>
<span id="cb16-53"><a href="#cb16-53" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">&quot;R0&quot;</span>, <span class="fu">HTML</span>(<span class="st">&quot;Basic reproduction number, &lt;i&gt;R&lt;/i&gt;&lt;sub&gt;0&lt;/sub&gt;&quot;</span>),</span>
<span id="cb16-54"><a href="#cb16-54" tabindex="-1"></a>                <span class="at">value =</span> <span class="fl">1.3</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">5</span>, <span class="at">step =</span> <span class="fl">0.05</span>),</span>
<span id="cb16-55"><a href="#cb16-55" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">&quot;latent_pd&quot;</span>, <span class="st">&quot;Latent period (days)&quot;</span>, <span class="at">value =</span> <span class="dv">2</span>, <span class="at">min =</span> <span class="dv">1</span>, <span class="at">max =</span> <span class="dv">7</span>, <span class="at">step =</span> <span class="fl">0.1</span>),</span>
<span id="cb16-56"><a href="#cb16-56" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">&quot;infec_pd&quot;</span>, <span class="st">&quot;Infectious period (days)&quot;</span>, <span class="at">value =</span> <span class="dv">7</span>, <span class="at">min =</span> <span class="dv">1</span>, <span class="at">max =</span> <span class="dv">10</span>, <span class="at">step =</span> <span class="fl">0.1</span>)</span>
<span id="cb16-57"><a href="#cb16-57" tabindex="-1"></a>        ),</span>
<span id="cb16-58"><a href="#cb16-58" tabindex="-1"></a></span>
<span id="cb16-59"><a href="#cb16-59" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">4</span>,</span>
<span id="cb16-60"><a href="#cb16-60" tabindex="-1"></a>            <span class="co"># Overlay controls: tokens that can be dragged onto the plot</span></span>
<span id="cb16-61"><a href="#cb16-61" tabindex="-1"></a>            <span class="fu">h3</span>(<span class="st">&quot;Interventions&quot;</span>)</span>
<span id="cb16-62"><a href="#cb16-62" tabindex="-1"></a>        )</span>
<span id="cb16-63"><a href="#cb16-63" tabindex="-1"></a>    )</span>
<span id="cb16-64"><a href="#cb16-64" tabindex="-1"></a>)</span>
<span id="cb16-65"><a href="#cb16-65" tabindex="-1"></a></span>
<span id="cb16-66"><a href="#cb16-66" tabindex="-1"></a><span class="co"># --- App logic ---</span></span>
<span id="cb16-67"><a href="#cb16-67" tabindex="-1"></a>server <span class="ot">&lt;-</span> <span class="cf">function</span>(input, output)</span>
<span id="cb16-68"><a href="#cb16-68" tabindex="-1"></a>{</span>
<span id="cb16-69"><a href="#cb16-69" tabindex="-1"></a>    output<span class="sc">$</span>display <span class="ot">&lt;-</span> <span class="fu">renderPlot</span>({</span>
<span id="cb16-70"><a href="#cb16-70" tabindex="-1"></a>        results <span class="ot">&lt;-</span> <span class="fu">run_model</span>(input)</span>
<span id="cb16-71"><a href="#cb16-71" tabindex="-1"></a>        results <span class="ot">&lt;-</span> results[results<span class="sc">$</span>compartment <span class="sc">==</span> <span class="st">&quot;infectious&quot;</span>, ]</span>
<span id="cb16-72"><a href="#cb16-72" tabindex="-1"></a>        <span class="fu">ggplot</span>(results) <span class="sc">+</span></span>
<span id="cb16-73"><a href="#cb16-73" tabindex="-1"></a>            <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time <span class="sc">+</span> input<span class="sc">$</span>date_range[<span class="dv">1</span>], <span class="at">y =</span> value <span class="sc">/</span> <span class="dv">1000</span>)) <span class="sc">+</span></span>
<span id="cb16-74"><a href="#cb16-74" tabindex="-1"></a>            <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">&quot;Infection prevalence (thousands)&quot;</span>) <span class="sc">+</span></span>
<span id="cb16-75"><a href="#cb16-75" tabindex="-1"></a>            <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="cn">NA</span>)</span>
<span id="cb16-76"><a href="#cb16-76" tabindex="-1"></a>    })</span>
<span id="cb16-77"><a href="#cb16-77" tabindex="-1"></a>}</span>
<span id="cb16-78"><a href="#cb16-78" tabindex="-1"></a></span>
<span id="cb16-79"><a href="#cb16-79" tabindex="-1"></a><span class="co"># --- Run app ---</span></span>
<span id="cb16-80"><a href="#cb16-80" tabindex="-1"></a><span class="fu">shinyApp</span>(ui, server)</span></code></pre></div>
</details>
<p>First, we now need to include the <code>overshiny</code> package
with:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="fu">library</span>(overshiny)</span></code></pre></div>
<p>Second, we need to change our <code>plotOutput</code> plot in our UI
to an <code>overlayPlotOutput</code> so that it can respond to
overlays:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>    <span class="co"># Main plot</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>    <span class="fu">overlayPlotOutput</span>(<span class="st">&quot;display&quot;</span>, <span class="at">width =</span> <span class="st">&quot;100%&quot;</span>, <span class="at">height =</span> <span class="dv">400</span>),</span></code></pre></div>
<p>Third, we need to add some <code>overlayToken()</code>s that can be
dragged onto the plot. Let’s put these into the currently-blank
“Interventions” section of our UI:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">4</span>,</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>            <span class="co"># Overlay controls: tokens that can be dragged onto the plot</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>            <span class="fu">h3</span>(<span class="st">&quot;Interventions&quot;</span>),</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>            <span class="fu">overlayToken</span>(<span class="st">&quot;vx&quot;</span>, <span class="st">&quot;Vaccination&quot;</span>),</span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>            <span class="fu">overlayToken</span>(<span class="st">&quot;tx&quot;</span>, <span class="st">&quot;Transmission&quot;</span>)</span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>        )</span></code></pre></div>
<p>Fourth, we need to initialize the overlay logic in our
<code>server</code> function by putting a call to
<code>overlayServer</code> at the top of the <code>server</code>
function:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="co"># --- App logic ---</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>server <span class="ot">&lt;-</span> <span class="cf">function</span>(input, output)</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>{</span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>    <span class="co"># --- OVERLAY SETUP ---</span></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>    <span class="co"># Initialise 8 draggable/resizable overlays</span></span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>    ov <span class="ot">&lt;-</span> <span class="fu">overlayServer</span>(<span class="st">&quot;display&quot;</span>, <span class="dv">8</span>)</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>    <span class="co"># rest of code follows as normal...</span></span></code></pre></div>
<p>We need to provide <code>overlayServer</code> with the id of our
<code>overlayPlot</code> (here, <code>&quot;display&quot;</code>) and the maximum
number of overlays to support.</p>
<p>And finally, we need to modify our call to <code>renderPlot()</code>
in the <code>server</code> function to tell <code>overshiny</code> more
information about our plot. Where before we had:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a>    output<span class="sc">$</span>display <span class="ot">&lt;-</span> <span class="fu">renderPlot</span>({</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>        results <span class="ot">&lt;-</span> <span class="fu">run_model</span>(input)</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>        results <span class="ot">&lt;-</span> results[results<span class="sc">$</span>compartment <span class="sc">==</span> <span class="st">&quot;infectious&quot;</span>, ]</span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>        <span class="fu">ggplot</span>(results) <span class="sc">+</span></span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a>            <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time <span class="sc">+</span> input<span class="sc">$</span>date_range[<span class="dv">1</span>], <span class="at">y =</span> value <span class="sc">/</span> <span class="dv">1000</span>)) <span class="sc">+</span></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a>            <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">&quot;Infection prevalence (thousands)&quot;</span>) <span class="sc">+</span></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a>            <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="cn">NA</span>)</span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a>    })</span></code></pre></div>
<p>Now, we have:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>    output<span class="sc">$</span>display <span class="ot">&lt;-</span> <span class="fu">renderPlot</span>({</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>        results <span class="ot">&lt;-</span> <span class="fu">run_model</span>(input)</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>        results <span class="ot">&lt;-</span> results[results<span class="sc">$</span>compartment <span class="sc">==</span> <span class="st">&quot;infectious&quot;</span>, ]</span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>        plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(results) <span class="sc">+</span></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a>            <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time <span class="sc">+</span> input<span class="sc">$</span>date_range[<span class="dv">1</span>], <span class="at">y =</span> value <span class="sc">/</span> <span class="dv">1000</span>)) <span class="sc">+</span></span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a>            <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">&quot;Infection prevalence (thousands)&quot;</span>) <span class="sc">+</span></span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a>            <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="cn">NA</span>)</span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a>        </span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a>        <span class="fu">overlayBounds</span>(ov, plot, <span class="at">xlim =</span> <span class="fu">c</span>(input<span class="sc">$</span>date_range), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>))</span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a>    })</span></code></pre></div>
<p>There are two changes above. First, rather than returning the
<code>ggplot()</code> plot, we save the plot in a variable called
<code>plot</code>. Second, we pass this through
<code>overlayBounds()</code>, which takes four key arguments:</p>
<ul>
<li><code>ov</code>, the object returned by
<code>overlayServer()</code>.</li>
<li><code>plot</code>, the plot itself.</li>
<li><code>xlim</code>, the x-coordinate limits of the plot.</li>
<li><code>ylim</code>, the y-coordinate limits of the plot.</li>
</ul>
<p><code>xlim</code> and <code>ylim</code> are not required, but because
<code>ggplot</code> by default includes a bit of extra space on the axes
(i.e. the x-axis doesn’t start precisely at the epidemic start date, but
a little before to provide some visual padding), providing these allows
<code>overshiny</code> to restrict the overlays such that they can only
move over the time span in which the epidemic is actually occurring.
It’s similar for <code>ylim</code> (try removing the <code>xlim</code>
and <code>ylim</code> arguments to <code>overlayBounds</code> to see
what happens.)</p>
<p><code>overlayBounds()</code> itself returns the <code>plot</code>
object, so it should be the last line in your expression that you pass
to <code>renderPlot()</code>.</p>
<p>You should now be able to drag the intervention tokens onto the plot,
where they will become overlays that you can move around, resize, and
remove by clicking on the “gears” icon on each overlay (then the
“remove” button). They won’t do anything yet to the epicurve yet,
though; that’s for the next section.</p>
<p>If you’ve gotten stuck and your code isn’t working, here’s some code
you could have arrived at:</p>
<details>
<summary>
Click for code…
</summary>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="fu">library</span>(shiny)</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a><span class="fu">library</span>(epidemics)</span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a><span class="fu">library</span>(overshiny)</span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a><span class="co"># Model run function</span></span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a>run_model <span class="ot">&lt;-</span> <span class="cf">function</span>(input)</span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a>{</span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a>    <span class="co"># Transform parameters</span></span>
<span id="cb23-10"><a href="#cb23-10" tabindex="-1"></a>    I0 <span class="ot">&lt;-</span> input<span class="sc">$</span>init_infec <span class="sc">/</span> <span class="dv">100</span>; <span class="co"># Percent to proportion</span></span>
<span id="cb23-11"><a href="#cb23-11" tabindex="-1"></a>    duration <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(input<span class="sc">$</span>date_range[<span class="dv">2</span>] <span class="sc">-</span> input<span class="sc">$</span>date_range[<span class="dv">1</span>]) <span class="co"># Dates to duration</span></span>
<span id="cb23-12"><a href="#cb23-12" tabindex="-1"></a>    infec_rate <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> input<span class="sc">$</span>latent_pd <span class="co"># Latent period to infectiousness rate</span></span>
<span id="cb23-13"><a href="#cb23-13" tabindex="-1"></a>    recov_rate <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> input<span class="sc">$</span>infec_pd  <span class="co"># Infectious period to recovery rate</span></span>
<span id="cb23-14"><a href="#cb23-14" tabindex="-1"></a>    trans_rate <span class="ot">&lt;-</span> input<span class="sc">$</span>R0 <span class="sc">*</span> recov_rate <span class="co"># R0 to transmission rate (R_0 = beta / gamma)</span></span>
<span id="cb23-15"><a href="#cb23-15" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" tabindex="-1"></a>    <span class="co"># Build population</span></span>
<span id="cb23-17"><a href="#cb23-17" tabindex="-1"></a>    pop <span class="ot">&lt;-</span> <span class="fu">population</span>(</span>
<span id="cb23-18"><a href="#cb23-18" tabindex="-1"></a>        <span class="at">name =</span> <span class="st">&quot;Utopia&quot;</span>,</span>
<span id="cb23-19"><a href="#cb23-19" tabindex="-1"></a>        <span class="at">contact_matrix =</span> <span class="fu">matrix</span>(<span class="dv">1</span>),</span>
<span id="cb23-20"><a href="#cb23-20" tabindex="-1"></a>        <span class="at">demography_vector =</span> input<span class="sc">$</span>pop_size <span class="sc">*</span> <span class="dv">1000000</span>, <span class="co"># Population size in millions</span></span>
<span id="cb23-21"><a href="#cb23-21" tabindex="-1"></a>        <span class="at">initial_conditions =</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span> <span class="sc">-</span> I0, <span class="dv">0</span>, I0, <span class="dv">0</span>, <span class="dv">0</span>), <span class="at">nrow =</span> <span class="dv">1</span>)</span>
<span id="cb23-22"><a href="#cb23-22" tabindex="-1"></a>    )</span>
<span id="cb23-23"><a href="#cb23-23" tabindex="-1"></a></span>
<span id="cb23-24"><a href="#cb23-24" tabindex="-1"></a>    <span class="co"># Run model</span></span>
<span id="cb23-25"><a href="#cb23-25" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">model_default</span>(pop, <span class="at">transmission_rate =</span> trans_rate,</span>
<span id="cb23-26"><a href="#cb23-26" tabindex="-1"></a>        <span class="at">infectiousness_rate =</span> infec_rate, <span class="at">recovery_rate =</span> recov_rate,</span>
<span id="cb23-27"><a href="#cb23-27" tabindex="-1"></a>        <span class="at">time_end =</span> duration)</span>
<span id="cb23-28"><a href="#cb23-28" tabindex="-1"></a></span>
<span id="cb23-29"><a href="#cb23-29" tabindex="-1"></a>    <span class="fu">return</span> (results)</span>
<span id="cb23-30"><a href="#cb23-30" tabindex="-1"></a>}</span>
<span id="cb23-31"><a href="#cb23-31" tabindex="-1"></a></span>
<span id="cb23-32"><a href="#cb23-32" tabindex="-1"></a><span class="co"># --- User interface ---</span></span>
<span id="cb23-33"><a href="#cb23-33" tabindex="-1"></a>ui <span class="ot">&lt;-</span> <span class="fu">fluidPage</span>(</span>
<span id="cb23-34"><a href="#cb23-34" tabindex="-1"></a>    <span class="fu">titlePanel</span>(<span class="st">&quot;SEIRV model with interventions&quot;</span>),</span>
<span id="cb23-35"><a href="#cb23-35" tabindex="-1"></a>    </span>
<span id="cb23-36"><a href="#cb23-36" tabindex="-1"></a>    <span class="co"># NEW PART IS HERE:</span></span>
<span id="cb23-37"><a href="#cb23-37" tabindex="-1"></a>    <span class="co"># Main plot</span></span>
<span id="cb23-38"><a href="#cb23-38" tabindex="-1"></a>    <span class="fu">overlayPlotOutput</span>(<span class="st">&quot;display&quot;</span>, <span class="at">width =</span> <span class="st">&quot;100%&quot;</span>, <span class="at">height =</span> <span class="dv">400</span>),</span>
<span id="cb23-39"><a href="#cb23-39" tabindex="-1"></a>    <span class="co"># </span><span class="re">END</span><span class="co"> OF NEW PART</span></span>
<span id="cb23-40"><a href="#cb23-40" tabindex="-1"></a></span>
<span id="cb23-41"><a href="#cb23-41" tabindex="-1"></a>    <span class="co"># 3 columns of inputs</span></span>
<span id="cb23-42"><a href="#cb23-42" tabindex="-1"></a>    <span class="fu">fluidRow</span>(</span>
<span id="cb23-43"><a href="#cb23-43" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">4</span>,</span>
<span id="cb23-44"><a href="#cb23-44" tabindex="-1"></a>            <span class="co"># Basic epidemic settings</span></span>
<span id="cb23-45"><a href="#cb23-45" tabindex="-1"></a>            <span class="fu">h3</span>(<span class="st">&quot;Epidemic&quot;</span>),</span>
<span id="cb23-46"><a href="#cb23-46" tabindex="-1"></a>            <span class="fu">dateRangeInput</span>(<span class="st">&quot;date_range&quot;</span>, <span class="st">&quot;Date range&quot;</span>, <span class="at">start =</span> <span class="st">&quot;2025-01-01&quot;</span>, <span class="at">end =</span> <span class="st">&quot;2025-12-31&quot;</span>),</span>
<span id="cb23-47"><a href="#cb23-47" tabindex="-1"></a>            <span class="fu">numericInput</span>(<span class="st">&quot;pop_size&quot;</span>, <span class="st">&quot;Population size (millions)&quot;</span>, <span class="at">value =</span> <span class="dv">59</span>, <span class="at">min =</span> <span class="dv">1</span>),</span>
<span id="cb23-48"><a href="#cb23-48" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">&quot;init_infec&quot;</span>, <span class="st">&quot;Initial proportion infectious (%)&quot;</span>, <span class="at">value =</span> <span class="fl">0.1</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>, <span class="at">step =</span> <span class="fl">0.01</span>)</span>
<span id="cb23-49"><a href="#cb23-49" tabindex="-1"></a>        ),</span>
<span id="cb23-50"><a href="#cb23-50" tabindex="-1"></a></span>
<span id="cb23-51"><a href="#cb23-51" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">4</span>,</span>
<span id="cb23-52"><a href="#cb23-52" tabindex="-1"></a>            <span class="co"># Pathogen settings</span></span>
<span id="cb23-53"><a href="#cb23-53" tabindex="-1"></a>            <span class="fu">h3</span>(<span class="st">&quot;Pathogen&quot;</span>),</span>
<span id="cb23-54"><a href="#cb23-54" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">&quot;R0&quot;</span>, <span class="fu">HTML</span>(<span class="st">&quot;Basic reproduction number, &lt;i&gt;R&lt;/i&gt;&lt;sub&gt;0&lt;/sub&gt;&quot;</span>),</span>
<span id="cb23-55"><a href="#cb23-55" tabindex="-1"></a>                <span class="at">value =</span> <span class="fl">1.3</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">5</span>, <span class="at">step =</span> <span class="fl">0.05</span>),</span>
<span id="cb23-56"><a href="#cb23-56" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">&quot;latent_pd&quot;</span>, <span class="st">&quot;Latent period (days)&quot;</span>, <span class="at">value =</span> <span class="dv">2</span>, <span class="at">min =</span> <span class="dv">1</span>, <span class="at">max =</span> <span class="dv">7</span>, <span class="at">step =</span> <span class="fl">0.1</span>),</span>
<span id="cb23-57"><a href="#cb23-57" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">&quot;infec_pd&quot;</span>, <span class="st">&quot;Infectious period (days)&quot;</span>, <span class="at">value =</span> <span class="dv">7</span>, <span class="at">min =</span> <span class="dv">1</span>, <span class="at">max =</span> <span class="dv">10</span>, <span class="at">step =</span> <span class="fl">0.1</span>)</span>
<span id="cb23-58"><a href="#cb23-58" tabindex="-1"></a>        ),</span>
<span id="cb23-59"><a href="#cb23-59" tabindex="-1"></a></span>
<span id="cb23-60"><a href="#cb23-60" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">4</span>,</span>
<span id="cb23-61"><a href="#cb23-61" tabindex="-1"></a>            <span class="co"># Overlay controls: tokens that can be dragged onto the plot</span></span>
<span id="cb23-62"><a href="#cb23-62" tabindex="-1"></a>            <span class="fu">h3</span>(<span class="st">&quot;Interventions&quot;</span>),</span>
<span id="cb23-63"><a href="#cb23-63" tabindex="-1"></a>            <span class="fu">overlayToken</span>(<span class="st">&quot;vx&quot;</span>, <span class="st">&quot;Vaccination&quot;</span>),</span>
<span id="cb23-64"><a href="#cb23-64" tabindex="-1"></a>            <span class="fu">overlayToken</span>(<span class="st">&quot;tx&quot;</span>, <span class="st">&quot;Transmission&quot;</span>)</span>
<span id="cb23-65"><a href="#cb23-65" tabindex="-1"></a>        )</span>
<span id="cb23-66"><a href="#cb23-66" tabindex="-1"></a>    )</span>
<span id="cb23-67"><a href="#cb23-67" tabindex="-1"></a>)</span>
<span id="cb23-68"><a href="#cb23-68" tabindex="-1"></a></span>
<span id="cb23-69"><a href="#cb23-69" tabindex="-1"></a><span class="co"># --- App logic ---</span></span>
<span id="cb23-70"><a href="#cb23-70" tabindex="-1"></a>server <span class="ot">&lt;-</span> <span class="cf">function</span>(input, output)</span>
<span id="cb23-71"><a href="#cb23-71" tabindex="-1"></a>{</span>
<span id="cb23-72"><a href="#cb23-72" tabindex="-1"></a>    <span class="co"># --- OVERLAY SETUP ---</span></span>
<span id="cb23-73"><a href="#cb23-73" tabindex="-1"></a></span>
<span id="cb23-74"><a href="#cb23-74" tabindex="-1"></a>    <span class="co"># Initialise 8 draggable/resizable overlays</span></span>
<span id="cb23-75"><a href="#cb23-75" tabindex="-1"></a>    ov <span class="ot">&lt;-</span> <span class="fu">overlayServer</span>(<span class="st">&quot;display&quot;</span>, <span class="dv">8</span>)</span>
<span id="cb23-76"><a href="#cb23-76" tabindex="-1"></a>    </span>
<span id="cb23-77"><a href="#cb23-77" tabindex="-1"></a>    <span class="co"># --- RENDERING OF EPI CURVES ---</span></span>
<span id="cb23-78"><a href="#cb23-78" tabindex="-1"></a></span>
<span id="cb23-79"><a href="#cb23-79" tabindex="-1"></a>    output<span class="sc">$</span>display <span class="ot">&lt;-</span> <span class="fu">renderPlot</span>({</span>
<span id="cb23-80"><a href="#cb23-80" tabindex="-1"></a>        results <span class="ot">&lt;-</span> <span class="fu">run_model</span>(input)</span>
<span id="cb23-81"><a href="#cb23-81" tabindex="-1"></a>        results <span class="ot">&lt;-</span> results[results<span class="sc">$</span>compartment <span class="sc">==</span> <span class="st">&quot;infectious&quot;</span>, ]</span>
<span id="cb23-82"><a href="#cb23-82" tabindex="-1"></a>        plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(results) <span class="sc">+</span></span>
<span id="cb23-83"><a href="#cb23-83" tabindex="-1"></a>            <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time <span class="sc">+</span> input<span class="sc">$</span>date_range[<span class="dv">1</span>], <span class="at">y =</span> value <span class="sc">/</span> <span class="dv">1000</span>)) <span class="sc">+</span></span>
<span id="cb23-84"><a href="#cb23-84" tabindex="-1"></a>            <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">&quot;Infection prevalence (thousands)&quot;</span>) <span class="sc">+</span></span>
<span id="cb23-85"><a href="#cb23-85" tabindex="-1"></a>            <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="cn">NA</span>)</span>
<span id="cb23-86"><a href="#cb23-86" tabindex="-1"></a>        </span>
<span id="cb23-87"><a href="#cb23-87" tabindex="-1"></a>        <span class="fu">overlayBounds</span>(ov, plot, <span class="at">xlim =</span> <span class="fu">c</span>(input<span class="sc">$</span>date_range), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>))</span>
<span id="cb23-88"><a href="#cb23-88" tabindex="-1"></a>    })</span>
<span id="cb23-89"><a href="#cb23-89" tabindex="-1"></a>}</span>
<span id="cb23-90"><a href="#cb23-90" tabindex="-1"></a></span>
<span id="cb23-91"><a href="#cb23-91" tabindex="-1"></a><span class="co"># --- Run app ---</span></span>
<span id="cb23-92"><a href="#cb23-92" tabindex="-1"></a><span class="fu">shinyApp</span>(ui, server)</span></code></pre></div>
</details>
<p>That’s how <code>overshiny</code> works; the rest of this tutorial is
just about connecting <code>overshiny</code> with <code>epidemics</code>
so that the overlays on the plot actually have an effect on the epidemic
model.</p>
<div id="making-the-interventions-work" class="section level2">
<h2>Making the interventions work</h2>
<p>The last piece of the puzzle is to make the interventions actually
have an impact on the simulated epidemic. Already, we are using the
function <code>model_default()</code> from <code>epidemics</code> to run
our model, and now we will use the <code>intervention</code> and
<code>vaccination</code> arguments to <code>model_default()</code> to
make our interventions work.</p>
<p>First, let’s change <code>run_model()</code> so that it can pass on
these extra parameters (<code>intervention</code> and
<code>vaccination</code>) to <code>epidemics::model_default()</code>. To
do that, add a <code>...</code> to the list of parameters so that
<code>run_model()</code> can take other (arbitrarily-named) parameters
and pass them on to <code>model_default()</code>, like so (there are
just two changes to make):</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="co"># Model run function</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>run_model <span class="ot">&lt;-</span> <span class="cf">function</span>(input, ...)  <span class="co"># &lt;-- FIRST CHANGE HERE</span></span></code></pre></div>
<p>… and then …</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a>    <span class="co"># Run model</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">model_default</span>(pop, <span class="at">transmission_rate =</span> trans_rate,</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>        <span class="at">infectiousness_rate =</span> infec_rate, <span class="at">recovery_rate =</span> recov_rate,</span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a>        <span class="at">time_end =</span> duration, ...) <span class="co"># &lt;-- SECOND CHANGE HERE</span></span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a>    <span class="fu">return</span> (results)</span></code></pre></div>
<p>Now, let’s modify the call to <code>renderPlot</code> so that it
reads in what overlays have been placed onto the plot, and fills out the
<code>intervention</code> and <code>vaccination</code> parameters
accordingly.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>    output<span class="sc">$</span>display <span class="ot">&lt;-</span> <span class="fu">renderPlot</span>({</span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>        <span class="co"># Create interventions</span></span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>        tx_int <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>        vax <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a>        </span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a>        <span class="co"># Apply overlays as interventions</span></span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a>        <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">which</span>(ov<span class="sc">$</span>active)) {</span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a>            begin <span class="ot">&lt;-</span> ov<span class="sc">$</span>cx0[i] <span class="sc">-</span> <span class="fu">as.numeric</span>(input<span class="sc">$</span>date_range[<span class="dv">1</span>])</span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a>            end <span class="ot">&lt;-</span> ov<span class="sc">$</span>cx1[i] <span class="sc">-</span> <span class="fu">as.numeric</span>(input<span class="sc">$</span>date_range[<span class="dv">1</span>])</span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a>            <span class="cf">if</span> (ov<span class="sc">$</span>label[i] <span class="sc">==</span> <span class="st">&quot;Vaccination&quot;</span>) {</span>
<span id="cb26-11"><a href="#cb26-11" tabindex="-1"></a>                nu <span class="ot">&lt;-</span> <span class="fl">0.01</span> <span class="co"># proportion of population vaccinated per day</span></span>
<span id="cb26-12"><a href="#cb26-12" tabindex="-1"></a>                <span class="cf">if</span> (<span class="fu">is.null</span>(vax)) {</span>
<span id="cb26-13"><a href="#cb26-13" tabindex="-1"></a>                    vax <span class="ot">&lt;-</span> <span class="fu">vaccination</span>(<span class="at">name =</span> <span class="fu">as.character</span>(i), <span class="at">nu =</span> <span class="fu">matrix</span>(nu),</span>
<span id="cb26-14"><a href="#cb26-14" tabindex="-1"></a>                        <span class="at">time_begin =</span> <span class="fu">matrix</span>(begin), <span class="at">time_end =</span> <span class="fu">matrix</span>(end))</span>
<span id="cb26-15"><a href="#cb26-15" tabindex="-1"></a>                } <span class="cf">else</span> {</span>
<span id="cb26-16"><a href="#cb26-16" tabindex="-1"></a>                    ov<span class="sc">$</span>active[i] <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb26-17"><a href="#cb26-17" tabindex="-1"></a>                }</span>
<span id="cb26-18"><a href="#cb26-18" tabindex="-1"></a>            } <span class="cf">else</span> <span class="cf">if</span> (ov<span class="sc">$</span>label[i] <span class="sc">==</span> <span class="st">&quot;Transmission&quot;</span>) {</span>
<span id="cb26-19"><a href="#cb26-19" tabindex="-1"></a>                reduc <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="co"># reduction in transmission</span></span>
<span id="cb26-20"><a href="#cb26-20" tabindex="-1"></a>                tx_int[[<span class="fu">length</span>(tx_int) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">intervention</span>(<span class="at">name =</span> <span class="fu">as.character</span>(i),</span>
<span id="cb26-21"><a href="#cb26-21" tabindex="-1"></a>                    <span class="at">type =</span> <span class="st">&quot;rate&quot;</span>, <span class="at">time_begin =</span> <span class="fu">matrix</span>(begin), <span class="at">time_end =</span> <span class="fu">matrix</span>(end),</span>
<span id="cb26-22"><a href="#cb26-22" tabindex="-1"></a>                    <span class="at">reduction =</span> reduc)</span>
<span id="cb26-23"><a href="#cb26-23" tabindex="-1"></a>            }</span>
<span id="cb26-24"><a href="#cb26-24" tabindex="-1"></a>        }</span>
<span id="cb26-25"><a href="#cb26-25" tabindex="-1"></a></span>
<span id="cb26-26"><a href="#cb26-26" tabindex="-1"></a>        <span class="co"># Put interventions in the right format</span></span>
<span id="cb26-27"><a href="#cb26-27" tabindex="-1"></a>        int <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb26-28"><a href="#cb26-28" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">length</span>(tx_int)) {</span>
<span id="cb26-29"><a href="#cb26-29" tabindex="-1"></a>            int[[<span class="st">&quot;transmission_rate&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">do.call</span>(c, tx_int)</span>
<span id="cb26-30"><a href="#cb26-30" tabindex="-1"></a>        }</span>
<span id="cb26-31"><a href="#cb26-31" tabindex="-1"></a>        </span>
<span id="cb26-32"><a href="#cb26-32" tabindex="-1"></a>        <span class="co"># Run model</span></span>
<span id="cb26-33"><a href="#cb26-33" tabindex="-1"></a>        results <span class="ot">&lt;-</span> <span class="fu">run_model</span>(input,</span>
<span id="cb26-34"><a href="#cb26-34" tabindex="-1"></a>            <span class="at">vaccination =</span> vax,</span>
<span id="cb26-35"><a href="#cb26-35" tabindex="-1"></a>            <span class="at">intervention =</span> <span class="cf">if</span> (<span class="fu">length</span>(int)) int <span class="cf">else</span> <span class="cn">NULL</span>)</span>
<span id="cb26-36"><a href="#cb26-36" tabindex="-1"></a>        </span>
<span id="cb26-37"><a href="#cb26-37" tabindex="-1"></a>        <span class="co"># Process results (this is the same as before)</span></span>
<span id="cb26-38"><a href="#cb26-38" tabindex="-1"></a>        results <span class="ot">&lt;-</span> results[results<span class="sc">$</span>compartment <span class="sc">==</span> <span class="st">&quot;infectious&quot;</span>, ]</span>
<span id="cb26-39"><a href="#cb26-39" tabindex="-1"></a>        plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(results) <span class="sc">+</span></span>
<span id="cb26-40"><a href="#cb26-40" tabindex="-1"></a>            <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time <span class="sc">+</span> input<span class="sc">$</span>date_range[<span class="dv">1</span>], <span class="at">y =</span> value <span class="sc">/</span> <span class="dv">1000</span>)) <span class="sc">+</span></span>
<span id="cb26-41"><a href="#cb26-41" tabindex="-1"></a>            <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">&quot;Infection prevalence (thousands)&quot;</span>) <span class="sc">+</span></span>
<span id="cb26-42"><a href="#cb26-42" tabindex="-1"></a>            <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="cn">NA</span>)</span>
<span id="cb26-43"><a href="#cb26-43" tabindex="-1"></a>        </span>
<span id="cb26-44"><a href="#cb26-44" tabindex="-1"></a>        <span class="fu">overlayBounds</span>(ov, plot, <span class="at">xlim =</span> <span class="fu">c</span>(input<span class="sc">$</span>date_range), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>))</span>
<span id="cb26-45"><a href="#cb26-45" tabindex="-1"></a>    })</span></code></pre></div>
<details>
<summary>
(Just in case, complete code for the whole script is here…)
</summary>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="fu">library</span>(shiny)</span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a><span class="fu">library</span>(epidemics)</span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a><span class="fu">library</span>(overshiny)</span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" tabindex="-1"></a><span class="co"># Model run function</span></span>
<span id="cb27-7"><a href="#cb27-7" tabindex="-1"></a>run_model <span class="ot">&lt;-</span> <span class="cf">function</span>(input, ...)</span>
<span id="cb27-8"><a href="#cb27-8" tabindex="-1"></a>{</span>
<span id="cb27-9"><a href="#cb27-9" tabindex="-1"></a>    <span class="co"># Transform parameters</span></span>
<span id="cb27-10"><a href="#cb27-10" tabindex="-1"></a>    I0 <span class="ot">&lt;-</span> input<span class="sc">$</span>init_infec <span class="sc">/</span> <span class="dv">100</span>; <span class="co"># Percent to proportion</span></span>
<span id="cb27-11"><a href="#cb27-11" tabindex="-1"></a>    duration <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(input<span class="sc">$</span>date_range[<span class="dv">2</span>] <span class="sc">-</span> input<span class="sc">$</span>date_range[<span class="dv">1</span>]) <span class="co"># Dates to duration</span></span>
<span id="cb27-12"><a href="#cb27-12" tabindex="-1"></a>    infec_rate <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> input<span class="sc">$</span>latent_pd <span class="co"># Latent period to infectiousness rate</span></span>
<span id="cb27-13"><a href="#cb27-13" tabindex="-1"></a>    recov_rate <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> input<span class="sc">$</span>infec_pd  <span class="co"># Infectious period to recovery rate</span></span>
<span id="cb27-14"><a href="#cb27-14" tabindex="-1"></a>    trans_rate <span class="ot">&lt;-</span> input<span class="sc">$</span>R0 <span class="sc">*</span> recov_rate <span class="co"># R0 to transmission rate (R_0 = beta / gamma)</span></span>
<span id="cb27-15"><a href="#cb27-15" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" tabindex="-1"></a>    <span class="co"># Build population</span></span>
<span id="cb27-17"><a href="#cb27-17" tabindex="-1"></a>    pop <span class="ot">&lt;-</span> <span class="fu">population</span>(</span>
<span id="cb27-18"><a href="#cb27-18" tabindex="-1"></a>        <span class="at">name =</span> <span class="st">&quot;Utopia&quot;</span>,</span>
<span id="cb27-19"><a href="#cb27-19" tabindex="-1"></a>        <span class="at">contact_matrix =</span> <span class="fu">matrix</span>(<span class="dv">1</span>),</span>
<span id="cb27-20"><a href="#cb27-20" tabindex="-1"></a>        <span class="at">demography_vector =</span> input<span class="sc">$</span>pop_size <span class="sc">*</span> <span class="dv">1000000</span>, <span class="co"># Population size in millions</span></span>
<span id="cb27-21"><a href="#cb27-21" tabindex="-1"></a>        <span class="at">initial_conditions =</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span> <span class="sc">-</span> I0, <span class="dv">0</span>, I0, <span class="dv">0</span>, <span class="dv">0</span>), <span class="at">nrow =</span> <span class="dv">1</span>)</span>
<span id="cb27-22"><a href="#cb27-22" tabindex="-1"></a>    )</span>
<span id="cb27-23"><a href="#cb27-23" tabindex="-1"></a></span>
<span id="cb27-24"><a href="#cb27-24" tabindex="-1"></a>    <span class="co"># Run model</span></span>
<span id="cb27-25"><a href="#cb27-25" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">model_default</span>(pop, <span class="at">transmission_rate =</span> trans_rate,</span>
<span id="cb27-26"><a href="#cb27-26" tabindex="-1"></a>        <span class="at">infectiousness_rate =</span> infec_rate, <span class="at">recovery_rate =</span> recov_rate,</span>
<span id="cb27-27"><a href="#cb27-27" tabindex="-1"></a>        <span class="at">time_end =</span> duration, ...)</span>
<span id="cb27-28"><a href="#cb27-28" tabindex="-1"></a></span>
<span id="cb27-29"><a href="#cb27-29" tabindex="-1"></a>    <span class="fu">return</span> (results)</span>
<span id="cb27-30"><a href="#cb27-30" tabindex="-1"></a>}</span>
<span id="cb27-31"><a href="#cb27-31" tabindex="-1"></a></span>
<span id="cb27-32"><a href="#cb27-32" tabindex="-1"></a><span class="co"># --- User interface ---</span></span>
<span id="cb27-33"><a href="#cb27-33" tabindex="-1"></a>ui <span class="ot">&lt;-</span> <span class="fu">fluidPage</span>(</span>
<span id="cb27-34"><a href="#cb27-34" tabindex="-1"></a>    <span class="fu">titlePanel</span>(<span class="st">&quot;SEIRV model with interventions&quot;</span>),</span>
<span id="cb27-35"><a href="#cb27-35" tabindex="-1"></a>    </span>
<span id="cb27-36"><a href="#cb27-36" tabindex="-1"></a>    <span class="co"># NEW PART IS HERE:</span></span>
<span id="cb27-37"><a href="#cb27-37" tabindex="-1"></a>    <span class="co"># Main plot</span></span>
<span id="cb27-38"><a href="#cb27-38" tabindex="-1"></a>    <span class="fu">overlayPlotOutput</span>(<span class="st">&quot;display&quot;</span>, <span class="at">width =</span> <span class="st">&quot;100%&quot;</span>, <span class="at">height =</span> <span class="dv">400</span>),</span>
<span id="cb27-39"><a href="#cb27-39" tabindex="-1"></a>    <span class="co"># </span><span class="re">END</span><span class="co"> OF NEW PART</span></span>
<span id="cb27-40"><a href="#cb27-40" tabindex="-1"></a></span>
<span id="cb27-41"><a href="#cb27-41" tabindex="-1"></a>    <span class="co"># 3 columns of inputs</span></span>
<span id="cb27-42"><a href="#cb27-42" tabindex="-1"></a>    <span class="fu">fluidRow</span>(</span>
<span id="cb27-43"><a href="#cb27-43" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">4</span>,</span>
<span id="cb27-44"><a href="#cb27-44" tabindex="-1"></a>            <span class="co"># Basic epidemic settings</span></span>
<span id="cb27-45"><a href="#cb27-45" tabindex="-1"></a>            <span class="fu">h3</span>(<span class="st">&quot;Epidemic&quot;</span>),</span>
<span id="cb27-46"><a href="#cb27-46" tabindex="-1"></a>            <span class="fu">dateRangeInput</span>(<span class="st">&quot;date_range&quot;</span>, <span class="st">&quot;Date range&quot;</span>, <span class="at">start =</span> <span class="st">&quot;2025-01-01&quot;</span>, <span class="at">end =</span> <span class="st">&quot;2025-12-31&quot;</span>),</span>
<span id="cb27-47"><a href="#cb27-47" tabindex="-1"></a>            <span class="fu">numericInput</span>(<span class="st">&quot;pop_size&quot;</span>, <span class="st">&quot;Population size (millions)&quot;</span>, <span class="at">value =</span> <span class="dv">59</span>, <span class="at">min =</span> <span class="dv">1</span>),</span>
<span id="cb27-48"><a href="#cb27-48" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">&quot;init_infec&quot;</span>, <span class="st">&quot;Initial proportion infectious (%)&quot;</span>, <span class="at">value =</span> <span class="fl">0.1</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>, <span class="at">step =</span> <span class="fl">0.01</span>)</span>
<span id="cb27-49"><a href="#cb27-49" tabindex="-1"></a>        ),</span>
<span id="cb27-50"><a href="#cb27-50" tabindex="-1"></a></span>
<span id="cb27-51"><a href="#cb27-51" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">4</span>,</span>
<span id="cb27-52"><a href="#cb27-52" tabindex="-1"></a>            <span class="co"># Pathogen settings</span></span>
<span id="cb27-53"><a href="#cb27-53" tabindex="-1"></a>            <span class="fu">h3</span>(<span class="st">&quot;Pathogen&quot;</span>),</span>
<span id="cb27-54"><a href="#cb27-54" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">&quot;R0&quot;</span>, <span class="fu">HTML</span>(<span class="st">&quot;Basic reproduction number, &lt;i&gt;R&lt;/i&gt;&lt;sub&gt;0&lt;/sub&gt;&quot;</span>),</span>
<span id="cb27-55"><a href="#cb27-55" tabindex="-1"></a>                <span class="at">value =</span> <span class="fl">1.3</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">5</span>, <span class="at">step =</span> <span class="fl">0.05</span>),</span>
<span id="cb27-56"><a href="#cb27-56" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">&quot;latent_pd&quot;</span>, <span class="st">&quot;Latent period (days)&quot;</span>, <span class="at">value =</span> <span class="dv">2</span>, <span class="at">min =</span> <span class="dv">1</span>, <span class="at">max =</span> <span class="dv">7</span>, <span class="at">step =</span> <span class="fl">0.1</span>),</span>
<span id="cb27-57"><a href="#cb27-57" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">&quot;infec_pd&quot;</span>, <span class="st">&quot;Infectious period (days)&quot;</span>, <span class="at">value =</span> <span class="dv">7</span>, <span class="at">min =</span> <span class="dv">1</span>, <span class="at">max =</span> <span class="dv">10</span>, <span class="at">step =</span> <span class="fl">0.1</span>)</span>
<span id="cb27-58"><a href="#cb27-58" tabindex="-1"></a>        ),</span>
<span id="cb27-59"><a href="#cb27-59" tabindex="-1"></a></span>
<span id="cb27-60"><a href="#cb27-60" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">4</span>,</span>
<span id="cb27-61"><a href="#cb27-61" tabindex="-1"></a>            <span class="co"># Overlay controls: tokens that can be dragged onto the plot</span></span>
<span id="cb27-62"><a href="#cb27-62" tabindex="-1"></a>            <span class="fu">h3</span>(<span class="st">&quot;Interventions&quot;</span>),</span>
<span id="cb27-63"><a href="#cb27-63" tabindex="-1"></a>            <span class="fu">overlayToken</span>(<span class="st">&quot;vx&quot;</span>, <span class="st">&quot;Vaccination&quot;</span>),</span>
<span id="cb27-64"><a href="#cb27-64" tabindex="-1"></a>            <span class="fu">overlayToken</span>(<span class="st">&quot;tx&quot;</span>, <span class="st">&quot;Transmission&quot;</span>)</span>
<span id="cb27-65"><a href="#cb27-65" tabindex="-1"></a>        )</span>
<span id="cb27-66"><a href="#cb27-66" tabindex="-1"></a>    )</span>
<span id="cb27-67"><a href="#cb27-67" tabindex="-1"></a>)</span>
<span id="cb27-68"><a href="#cb27-68" tabindex="-1"></a></span>
<span id="cb27-69"><a href="#cb27-69" tabindex="-1"></a><span class="co"># --- App logic ---</span></span>
<span id="cb27-70"><a href="#cb27-70" tabindex="-1"></a>server <span class="ot">&lt;-</span> <span class="cf">function</span>(input, output)</span>
<span id="cb27-71"><a href="#cb27-71" tabindex="-1"></a>{</span>
<span id="cb27-72"><a href="#cb27-72" tabindex="-1"></a>    <span class="co"># --- OVERLAY SETUP ---</span></span>
<span id="cb27-73"><a href="#cb27-73" tabindex="-1"></a></span>
<span id="cb27-74"><a href="#cb27-74" tabindex="-1"></a>    <span class="co"># Initialise 8 draggable/resizable overlays</span></span>
<span id="cb27-75"><a href="#cb27-75" tabindex="-1"></a>    ov <span class="ot">&lt;-</span> <span class="fu">overlayServer</span>(<span class="st">&quot;display&quot;</span>, <span class="dv">8</span>)</span>
<span id="cb27-76"><a href="#cb27-76" tabindex="-1"></a>    </span>
<span id="cb27-77"><a href="#cb27-77" tabindex="-1"></a>    <span class="co"># --- RENDERING OF EPI CURVES ---</span></span>
<span id="cb27-78"><a href="#cb27-78" tabindex="-1"></a></span>
<span id="cb27-79"><a href="#cb27-79" tabindex="-1"></a>    output<span class="sc">$</span>display <span class="ot">&lt;-</span> <span class="fu">renderPlot</span>({</span>
<span id="cb27-80"><a href="#cb27-80" tabindex="-1"></a>        <span class="co"># Create interventions</span></span>
<span id="cb27-81"><a href="#cb27-81" tabindex="-1"></a>        tx_int <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb27-82"><a href="#cb27-82" tabindex="-1"></a>        vax <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb27-83"><a href="#cb27-83" tabindex="-1"></a>        </span>
<span id="cb27-84"><a href="#cb27-84" tabindex="-1"></a>        <span class="co"># Apply overlays as interventions</span></span>
<span id="cb27-85"><a href="#cb27-85" tabindex="-1"></a>        <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">which</span>(ov<span class="sc">$</span>active)) {</span>
<span id="cb27-86"><a href="#cb27-86" tabindex="-1"></a>            begin <span class="ot">&lt;-</span> ov<span class="sc">$</span>cx0[i] <span class="sc">-</span> <span class="fu">as.numeric</span>(input<span class="sc">$</span>date_range[<span class="dv">1</span>])</span>
<span id="cb27-87"><a href="#cb27-87" tabindex="-1"></a>            end <span class="ot">&lt;-</span> ov<span class="sc">$</span>cx1[i] <span class="sc">-</span> <span class="fu">as.numeric</span>(input<span class="sc">$</span>date_range[<span class="dv">1</span>])</span>
<span id="cb27-88"><a href="#cb27-88" tabindex="-1"></a>            <span class="cf">if</span> (ov<span class="sc">$</span>label[i] <span class="sc">==</span> <span class="st">&quot;Vaccination&quot;</span>) {</span>
<span id="cb27-89"><a href="#cb27-89" tabindex="-1"></a>                nu <span class="ot">&lt;-</span> <span class="fl">0.01</span> <span class="co"># proportion of population vaccinated per day</span></span>
<span id="cb27-90"><a href="#cb27-90" tabindex="-1"></a>                <span class="cf">if</span> (<span class="fu">is.null</span>(vax)) {</span>
<span id="cb27-91"><a href="#cb27-91" tabindex="-1"></a>                    vax <span class="ot">&lt;-</span> <span class="fu">vaccination</span>(<span class="at">name =</span> <span class="fu">as.character</span>(i), <span class="at">nu =</span> <span class="fu">matrix</span>(nu),</span>
<span id="cb27-92"><a href="#cb27-92" tabindex="-1"></a>                        <span class="at">time_begin =</span> <span class="fu">matrix</span>(begin), <span class="at">time_end =</span> <span class="fu">matrix</span>(end))</span>
<span id="cb27-93"><a href="#cb27-93" tabindex="-1"></a>                } <span class="cf">else</span> {</span>
<span id="cb27-94"><a href="#cb27-94" tabindex="-1"></a>                    ov<span class="sc">$</span>active[i] <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb27-95"><a href="#cb27-95" tabindex="-1"></a>                }</span>
<span id="cb27-96"><a href="#cb27-96" tabindex="-1"></a>            } <span class="cf">else</span> <span class="cf">if</span> (ov<span class="sc">$</span>label[i] <span class="sc">==</span> <span class="st">&quot;Transmission&quot;</span>) {</span>
<span id="cb27-97"><a href="#cb27-97" tabindex="-1"></a>                reduc <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="co"># reduction in transmission</span></span>
<span id="cb27-98"><a href="#cb27-98" tabindex="-1"></a>                tx_int[[<span class="fu">length</span>(tx_int) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">intervention</span>(<span class="at">name =</span> <span class="fu">as.character</span>(i),</span>
<span id="cb27-99"><a href="#cb27-99" tabindex="-1"></a>                    <span class="at">type =</span> <span class="st">&quot;rate&quot;</span>, <span class="at">time_begin =</span> <span class="fu">matrix</span>(begin), <span class="at">time_end =</span> <span class="fu">matrix</span>(end),</span>
<span id="cb27-100"><a href="#cb27-100" tabindex="-1"></a>                    <span class="at">reduction =</span> reduc)</span>
<span id="cb27-101"><a href="#cb27-101" tabindex="-1"></a>            }</span>
<span id="cb27-102"><a href="#cb27-102" tabindex="-1"></a>        }</span>
<span id="cb27-103"><a href="#cb27-103" tabindex="-1"></a></span>
<span id="cb27-104"><a href="#cb27-104" tabindex="-1"></a>        <span class="co"># Put interventions in the right format</span></span>
<span id="cb27-105"><a href="#cb27-105" tabindex="-1"></a>        int <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb27-106"><a href="#cb27-106" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">length</span>(tx_int)) {</span>
<span id="cb27-107"><a href="#cb27-107" tabindex="-1"></a>            int[[<span class="st">&quot;transmission_rate&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">do.call</span>(c, tx_int)</span>
<span id="cb27-108"><a href="#cb27-108" tabindex="-1"></a>        }</span>
<span id="cb27-109"><a href="#cb27-109" tabindex="-1"></a>        </span>
<span id="cb27-110"><a href="#cb27-110" tabindex="-1"></a>        <span class="co"># Run model</span></span>
<span id="cb27-111"><a href="#cb27-111" tabindex="-1"></a>        results <span class="ot">&lt;-</span> <span class="fu">run_model</span>(input,</span>
<span id="cb27-112"><a href="#cb27-112" tabindex="-1"></a>            <span class="at">vaccination =</span> vax,</span>
<span id="cb27-113"><a href="#cb27-113" tabindex="-1"></a>            <span class="at">intervention =</span> <span class="cf">if</span> (<span class="fu">length</span>(int)) int <span class="cf">else</span> <span class="cn">NULL</span>)</span>
<span id="cb27-114"><a href="#cb27-114" tabindex="-1"></a>        </span>
<span id="cb27-115"><a href="#cb27-115" tabindex="-1"></a>        <span class="co"># Process results (this is the same as before)</span></span>
<span id="cb27-116"><a href="#cb27-116" tabindex="-1"></a>        results <span class="ot">&lt;-</span> results[results<span class="sc">$</span>compartment <span class="sc">==</span> <span class="st">&quot;infectious&quot;</span>, ]</span>
<span id="cb27-117"><a href="#cb27-117" tabindex="-1"></a>        plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(results) <span class="sc">+</span></span>
<span id="cb27-118"><a href="#cb27-118" tabindex="-1"></a>            <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time <span class="sc">+</span> input<span class="sc">$</span>date_range[<span class="dv">1</span>], <span class="at">y =</span> value <span class="sc">/</span> <span class="dv">1000</span>)) <span class="sc">+</span></span>
<span id="cb27-119"><a href="#cb27-119" tabindex="-1"></a>            <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">&quot;Infection prevalence (thousands)&quot;</span>) <span class="sc">+</span></span>
<span id="cb27-120"><a href="#cb27-120" tabindex="-1"></a>            <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="cn">NA</span>)</span>
<span id="cb27-121"><a href="#cb27-121" tabindex="-1"></a>        </span>
<span id="cb27-122"><a href="#cb27-122" tabindex="-1"></a>        <span class="fu">overlayBounds</span>(ov, plot, <span class="at">xlim =</span> <span class="fu">c</span>(input<span class="sc">$</span>date_range), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>))</span>
<span id="cb27-123"><a href="#cb27-123" tabindex="-1"></a>    })</span>
<span id="cb27-124"><a href="#cb27-124" tabindex="-1"></a>}</span>
<span id="cb27-125"><a href="#cb27-125" tabindex="-1"></a></span>
<span id="cb27-126"><a href="#cb27-126" tabindex="-1"></a><span class="co"># --- Run app ---</span></span>
<span id="cb27-127"><a href="#cb27-127" tabindex="-1"></a><span class="fu">shinyApp</span>(ui, server)</span></code></pre></div>
</details>
<p>Compare the new call to <code>renderPlot()</code> to what we had
before, which was:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>    output<span class="sc">$</span>display <span class="ot">&lt;-</span> <span class="fu">renderPlot</span>({</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>        results <span class="ot">&lt;-</span> <span class="fu">run_model</span>(input)</span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a>        results <span class="ot">&lt;-</span> results[results<span class="sc">$</span>compartment <span class="sc">==</span> <span class="st">&quot;infectious&quot;</span>, ]</span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a>        plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(results) <span class="sc">+</span></span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a>            <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time <span class="sc">+</span> input<span class="sc">$</span>date_range[<span class="dv">1</span>], <span class="at">y =</span> value <span class="sc">/</span> <span class="dv">1000</span>)) <span class="sc">+</span></span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a>            <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">&quot;Infection prevalence (thousands)&quot;</span>) <span class="sc">+</span></span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a>            <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="cn">NA</span>)</span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a>        </span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a>        <span class="fu">overlayBounds</span>(ov, plot, <span class="at">xlim =</span> <span class="fu">c</span>(input<span class="sc">$</span>date_range), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>))</span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a>    })</span></code></pre></div>
<p>A lot has been added, so let’s take it step by step. First:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a>        <span class="co"># Create interventions</span></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a>        tx_int <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a>        vax <span class="ot">&lt;-</span> <span class="cn">NULL</span></span></code></pre></div>
<p>Here, we create some variables that will hold details of the
interventions to apply; <code>tx_int</code> (for interventions on the
transmission rate) and <code>vax</code> (for a vaccination
campaign).</p>
<p>Then, we process the overlay data from the <code>ov</code> object
that is provided by <code>overlayServer()</code>:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a>        <span class="co"># Apply overlays as interventions</span></span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a>        <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">which</span>(ov<span class="sc">$</span>active)) {</span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a>            begin <span class="ot">&lt;-</span> ov<span class="sc">$</span>cx0[i] <span class="sc">-</span> <span class="fu">as.numeric</span>(input<span class="sc">$</span>date_range[<span class="dv">1</span>])</span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a>            end <span class="ot">&lt;-</span> ov<span class="sc">$</span>cx1[i] <span class="sc">-</span> <span class="fu">as.numeric</span>(input<span class="sc">$</span>date_range[<span class="dv">1</span>])</span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a>            <span class="cf">if</span> (ov<span class="sc">$</span>label[i] <span class="sc">==</span> <span class="st">&quot;Vaccination&quot;</span>) {</span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a>                nu <span class="ot">&lt;-</span> <span class="fl">0.01</span> <span class="co"># proportion of population vaccinated per day</span></span>
<span id="cb30-7"><a href="#cb30-7" tabindex="-1"></a>                <span class="cf">if</span> (<span class="fu">is.null</span>(vax)) {</span>
<span id="cb30-8"><a href="#cb30-8" tabindex="-1"></a>                    vax <span class="ot">&lt;-</span> <span class="fu">vaccination</span>(<span class="at">name =</span> <span class="fu">as.character</span>(i), <span class="at">nu =</span> <span class="fu">matrix</span>(nu),</span>
<span id="cb30-9"><a href="#cb30-9" tabindex="-1"></a>                        <span class="at">time_begin =</span> <span class="fu">matrix</span>(begin), <span class="at">time_end =</span> <span class="fu">matrix</span>(end))</span>
<span id="cb30-10"><a href="#cb30-10" tabindex="-1"></a>                } <span class="cf">else</span> {</span>
<span id="cb30-11"><a href="#cb30-11" tabindex="-1"></a>                    ov<span class="sc">$</span>active[i] <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb30-12"><a href="#cb30-12" tabindex="-1"></a>                }</span>
<span id="cb30-13"><a href="#cb30-13" tabindex="-1"></a>            } <span class="cf">else</span> <span class="cf">if</span> (ov<span class="sc">$</span>label[i] <span class="sc">==</span> <span class="st">&quot;Transmission&quot;</span>) {</span>
<span id="cb30-14"><a href="#cb30-14" tabindex="-1"></a>                reduc <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="co"># reduction in transmission</span></span>
<span id="cb30-15"><a href="#cb30-15" tabindex="-1"></a>                tx_int[[<span class="fu">length</span>(tx_int) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">intervention</span>(<span class="at">name =</span> <span class="fu">as.character</span>(i),</span>
<span id="cb30-16"><a href="#cb30-16" tabindex="-1"></a>                    <span class="at">type =</span> <span class="st">&quot;rate&quot;</span>, <span class="at">time_begin =</span> <span class="fu">matrix</span>(begin), <span class="at">time_end =</span> <span class="fu">matrix</span>(end),</span>
<span id="cb30-17"><a href="#cb30-17" tabindex="-1"></a>                    <span class="at">reduction =</span> reduc)</span>
<span id="cb30-18"><a href="#cb30-18" tabindex="-1"></a>            }</span>
<span id="cb30-19"><a href="#cb30-19" tabindex="-1"></a>        }</span></code></pre></div>
<p><code>ov$active</code> is a logical vector, the same length as the
maximum number of overlays (here, 8), which is <code>TRUE</code> for
overlays that are on the plot and <code>FALSE</code> for overlays that
aren’t. So <code>for (i in which(ov$active))</code> runs a loop for all
indices <code>i</code> that correspond to an “active” overlay.</p>
<p>Then we read <code>begin</code> and <code>end</code> – the start time
and end time for each intervention – from <code>ov$cx0</code> (the
starting x-coordinate of each overlay) and from <code>ov$cx1</code> (the
ending x-coordinate of each overlay). We work out how many days into the
epidemic <code>begin</code> and <code>end</code> are by subtracting the
numeric value of the start date of the epidemic,
<code>as.numeric(input$date_range[1])</code>.</p>
<p>Then, each overlay has a <code>label</code> which corresponds to the
<code>label</code> of the <code>overlayToken()</code> which created it.
So we check whether the overlay with index <code>i</code> is a
<code>&quot;Vaccination&quot;</code> or a <code>&quot;Transmission&quot;</code> overlay.</p>
<p>For vaccination overlays, we set the vaccination rate <code>nu</code>
to 0.01, which (to <code>epidemics</code>) means 1% of the population is
getting vaccinated per day. If there isn’t already a vaccination
intervention (and hence <code>vax</code> is <code>NULL</code>) then we
create one. If there is, then we can’t add a second vaccination
intervention since the <code>epidemics</code> package only allows one
vaccination intervention; so we deactivate the (second, superfluous)
vaccine intervention if one already exists.</p>
<p>For transmission overlays, we set the transmission reduction
<code>reduc</code> to 0.5, which means a reduction in the transmission
rate by 50%. We add our new intervention to the list
<code>tx_int</code>. <code>epidemics</code> <em>does</em> allow multiple
transmission-rate interventions, so we don’t need to limit the number of
these.</p>
<p>Next in the code, we have this:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a>        <span class="co"># Put interventions in the right format</span></span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a>        int <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">length</span>(tx_int)) {</span>
<span id="cb31-4"><a href="#cb31-4" tabindex="-1"></a>            int[[<span class="st">&quot;transmission_rate&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">do.call</span>(c, tx_int)</span>
<span id="cb31-5"><a href="#cb31-5" tabindex="-1"></a>        }</span>
<span id="cb31-6"><a href="#cb31-6" tabindex="-1"></a>        </span>
<span id="cb31-7"><a href="#cb31-7" tabindex="-1"></a>        <span class="co"># Run model</span></span>
<span id="cb31-8"><a href="#cb31-8" tabindex="-1"></a>        results <span class="ot">&lt;-</span> <span class="fu">run_model</span>(input,</span>
<span id="cb31-9"><a href="#cb31-9" tabindex="-1"></a>            <span class="at">vaccination =</span> vax,</span>
<span id="cb31-10"><a href="#cb31-10" tabindex="-1"></a>            <span class="at">intervention =</span> <span class="cf">if</span> (<span class="fu">length</span>(int)) int <span class="cf">else</span> <span class="cn">NULL</span>)</span></code></pre></div>
<p>This just turns our list of transmission interventions
<code>tx_int</code> into the right format for <code>epidemics</code> to
understand. It wants the <code>intervention</code> argument to be a list
with elements named <code>&quot;transmission_rate&quot;</code>,
<code>&quot;infectiousness_rate&quot;</code>, <code>&quot;recovery_rate&quot;</code>, or
<code>&quot;contacts&quot;</code> depending on what kind of intervention it is.
Each of these elements should be one or several interventions, and the
way to combine interventions is with <code>c()</code> (hence the
<code>do.call</code>).</p>
<p>Then the code above calls our function <code>run_model</code> with
the appropriately-formatted intervention data for
<code>vaccination</code> and <code>intervention</code>.</p>
<p>Put this all together, and you have a working app with intervention
overlays!</p>
</div>
</div>
<div id="next-steps" class="section level1">
<h1>Next steps</h1>
<p>We have come to the end of the tutorial. We haven’t explored
everything that <code>shiny</code> and <code>overshiny</code> can do,
but we have gone through the basics.</p>
<p>As a next step, it would be nice to modify our app to do two
things:</p>
<ol style="list-style-type: decimal">
<li>Compare the mitigated epidemic to the counterfactual–an unmitigated
epidemic without any interventions. We could do this by plotting both
epi curves, with the unmitigated epi curve in a lighter colour.</li>
<li>Allow us to customize the vaccination rate or the transmission
reduction percentage of each intervention, instead of leaving these at
0.1% and 50% respectively.</li>
</ol>
<p>The following script shows you how to accomplish both of these
things. Use the <code>shiny</code> and <code>overshiny</code> package
documentation for insight into what all the changes from your existing
code do and how they work. Good luck!</p>
<details>
<summary>
Click for advanced code…
</summary>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a><span class="fu">library</span>(epidemics)</span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a><span class="fu">library</span>(shiny)</span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a><span class="fu">library</span>(overshiny)</span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb32-5"><a href="#cb32-5" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" tabindex="-1"></a><span class="co"># --- User interface ---</span></span>
<span id="cb32-7"><a href="#cb32-7" tabindex="-1"></a>ui <span class="ot">&lt;-</span> <span class="fu">fluidPage</span>(</span>
<span id="cb32-8"><a href="#cb32-8" tabindex="-1"></a>    <span class="fu">titlePanel</span>(<span class="st">&quot;SEIRV model with interventions&quot;</span>),</span>
<span id="cb32-9"><a href="#cb32-9" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" tabindex="-1"></a>    <span class="co"># Main plot with support for overlays</span></span>
<span id="cb32-11"><a href="#cb32-11" tabindex="-1"></a>    <span class="fu">overlayPlotOutput</span>(<span class="st">&quot;display&quot;</span>, <span class="at">width =</span> <span class="st">&quot;100%&quot;</span>, <span class="at">height =</span> <span class="dv">400</span>),</span>
<span id="cb32-12"><a href="#cb32-12" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" tabindex="-1"></a>    <span class="co"># 3 columns of inputs</span></span>
<span id="cb32-14"><a href="#cb32-14" tabindex="-1"></a>    <span class="fu">fluidRow</span>(</span>
<span id="cb32-15"><a href="#cb32-15" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">4</span>,</span>
<span id="cb32-16"><a href="#cb32-16" tabindex="-1"></a>            <span class="co"># Basic epidemic settings</span></span>
<span id="cb32-17"><a href="#cb32-17" tabindex="-1"></a>            <span class="fu">h3</span>(<span class="st">&quot;Epidemic&quot;</span>),</span>
<span id="cb32-18"><a href="#cb32-18" tabindex="-1"></a>            <span class="fu">dateRangeInput</span>(<span class="st">&quot;date_range&quot;</span>, <span class="st">&quot;Date range&quot;</span>, <span class="at">start =</span> <span class="st">&quot;2025-01-01&quot;</span>, <span class="at">end =</span> <span class="st">&quot;2025-12-31&quot;</span>),</span>
<span id="cb32-19"><a href="#cb32-19" tabindex="-1"></a>            <span class="fu">numericInput</span>(<span class="st">&quot;pop_size&quot;</span>, <span class="st">&quot;Population size (millions)&quot;</span>, <span class="at">value =</span> <span class="dv">59</span>, <span class="at">min =</span> <span class="dv">1</span>),</span>
<span id="cb32-20"><a href="#cb32-20" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">&quot;init_infec&quot;</span>, <span class="st">&quot;Initial proportion infectious (%)&quot;</span>, <span class="at">value =</span> <span class="fl">0.1</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>, <span class="at">step =</span> <span class="fl">0.01</span>)</span>
<span id="cb32-21"><a href="#cb32-21" tabindex="-1"></a>        ),</span>
<span id="cb32-22"><a href="#cb32-22" tabindex="-1"></a></span>
<span id="cb32-23"><a href="#cb32-23" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">4</span>,</span>
<span id="cb32-24"><a href="#cb32-24" tabindex="-1"></a>            <span class="co"># Pathogen settings</span></span>
<span id="cb32-25"><a href="#cb32-25" tabindex="-1"></a>            <span class="fu">h3</span>(<span class="st">&quot;Pathogen&quot;</span>),</span>
<span id="cb32-26"><a href="#cb32-26" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">&quot;R0&quot;</span>, <span class="fu">HTML</span>(<span class="st">&quot;Basic reproduction number, &lt;i&gt;R&lt;/i&gt;&lt;sub&gt;0&lt;/sub&gt;&quot;</span>),</span>
<span id="cb32-27"><a href="#cb32-27" tabindex="-1"></a>                <span class="at">value =</span> <span class="fl">1.3</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">5</span>, <span class="at">step =</span> <span class="fl">0.05</span>),</span>
<span id="cb32-28"><a href="#cb32-28" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">&quot;latent_pd&quot;</span>, <span class="st">&quot;Latent period (days)&quot;</span>, <span class="at">value =</span> <span class="dv">2</span>, <span class="at">min =</span> <span class="dv">1</span>, <span class="at">max =</span> <span class="dv">7</span>, <span class="at">step =</span> <span class="fl">0.1</span>),</span>
<span id="cb32-29"><a href="#cb32-29" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">&quot;infec_pd&quot;</span>, <span class="st">&quot;Infectious period (days)&quot;</span>, <span class="at">value =</span> <span class="dv">7</span>, <span class="at">min =</span> <span class="dv">1</span>, <span class="at">max =</span> <span class="dv">10</span>, <span class="at">step =</span> <span class="fl">0.1</span>)</span>
<span id="cb32-30"><a href="#cb32-30" tabindex="-1"></a>        ),</span>
<span id="cb32-31"><a href="#cb32-31" tabindex="-1"></a></span>
<span id="cb32-32"><a href="#cb32-32" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">4</span>,</span>
<span id="cb32-33"><a href="#cb32-33" tabindex="-1"></a>            <span class="co"># Overlay controls: tokens that can be dragged onto the plot</span></span>
<span id="cb32-34"><a href="#cb32-34" tabindex="-1"></a>            <span class="fu">h3</span>(<span class="st">&quot;Interventions&quot;</span>),</span>
<span id="cb32-35"><a href="#cb32-35" tabindex="-1"></a>            <span class="fu">overlayToken</span>(<span class="st">&quot;vx&quot;</span>, <span class="st">&quot;Vaccination&quot;</span>),</span>
<span id="cb32-36"><a href="#cb32-36" tabindex="-1"></a>            <span class="fu">overlayToken</span>(<span class="st">&quot;tx&quot;</span>, <span class="st">&quot;Transmission&quot;</span>)</span>
<span id="cb32-37"><a href="#cb32-37" tabindex="-1"></a>        )</span>
<span id="cb32-38"><a href="#cb32-38" tabindex="-1"></a>    )</span>
<span id="cb32-39"><a href="#cb32-39" tabindex="-1"></a>)</span>
<span id="cb32-40"><a href="#cb32-40" tabindex="-1"></a></span>
<span id="cb32-41"><a href="#cb32-41" tabindex="-1"></a><span class="co"># --- App logic ---</span></span>
<span id="cb32-42"><a href="#cb32-42" tabindex="-1"></a>server <span class="ot">&lt;-</span> <span class="cf">function</span>(input, output)</span>
<span id="cb32-43"><a href="#cb32-43" tabindex="-1"></a>{</span>
<span id="cb32-44"><a href="#cb32-44" tabindex="-1"></a>    <span class="co"># --- OVERLAY SETUP ---</span></span>
<span id="cb32-45"><a href="#cb32-45" tabindex="-1"></a></span>
<span id="cb32-46"><a href="#cb32-46" tabindex="-1"></a>    <span class="co"># Dropdown menu for overlays</span></span>
<span id="cb32-47"><a href="#cb32-47" tabindex="-1"></a>    menu <span class="ot">&lt;-</span> <span class="cf">function</span>(ov, i) {</span>
<span id="cb32-48"><a href="#cb32-48" tabindex="-1"></a>        <span class="cf">if</span> (ov<span class="sc">$</span>label[i] <span class="sc">==</span> <span class="st">&quot;Vaccination&quot;</span>) {</span>
<span id="cb32-49"><a href="#cb32-49" tabindex="-1"></a>            <span class="fu">numericInput</span>(<span class="st">&quot;display_vac_rate&quot;</span>, <span class="st">&quot;Vaccines per day (thousands)&quot;</span>,</span>
<span id="cb32-50"><a href="#cb32-50" tabindex="-1"></a>                <span class="at">value =</span> ov<span class="sc">$</span>data<span class="sc">$</span>vac_rate[i], <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">10000</span>)</span>
<span id="cb32-51"><a href="#cb32-51" tabindex="-1"></a>        } <span class="cf">else</span> <span class="cf">if</span> (ov<span class="sc">$</span>label[i] <span class="sc">==</span> <span class="st">&quot;Transmission&quot;</span>) {</span>
<span id="cb32-52"><a href="#cb32-52" tabindex="-1"></a>            <span class="fu">sliderInput</span>(<span class="st">&quot;display_int_strength&quot;</span>, <span class="st">&quot;Transmission reduction (%)&quot;</span>,</span>
<span id="cb32-53"><a href="#cb32-53" tabindex="-1"></a>                <span class="at">value =</span> ov<span class="sc">$</span>data<span class="sc">$</span>int_strength[i], <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">100</span>)</span>
<span id="cb32-54"><a href="#cb32-54" tabindex="-1"></a>        }</span>
<span id="cb32-55"><a href="#cb32-55" tabindex="-1"></a>    }</span>
<span id="cb32-56"><a href="#cb32-56" tabindex="-1"></a></span>
<span id="cb32-57"><a href="#cb32-57" tabindex="-1"></a>    <span class="co"># Initialise 8 draggable/resizable overlays</span></span>
<span id="cb32-58"><a href="#cb32-58" tabindex="-1"></a>    ov <span class="ot">&lt;-</span> <span class="fu">overlayServer</span>(<span class="st">&quot;display&quot;</span>, <span class="dv">8</span>, <span class="at">width =</span> <span class="dv">56</span>, <span class="co"># 56 days = 8 weeks default width</span></span>
<span id="cb32-59"><a href="#cb32-59" tabindex="-1"></a>        <span class="at">data =</span> <span class="fu">list</span>(<span class="at">vac_rate =</span> <span class="dv">10</span>, <span class="at">int_strength =</span> <span class="dv">20</span>),</span>
<span id="cb32-60"><a href="#cb32-60" tabindex="-1"></a>        <span class="at">snap =</span> <span class="fu">snapGrid</span>(),</span>
<span id="cb32-61"><a href="#cb32-61" tabindex="-1"></a>        <span class="at">heading =</span> <span class="fu">dateHeading</span>(<span class="st">&quot;%b %e&quot;</span>),</span>
<span id="cb32-62"><a href="#cb32-62" tabindex="-1"></a>        <span class="at">select =</span> <span class="cn">TRUE</span>,</span>
<span id="cb32-63"><a href="#cb32-63" tabindex="-1"></a>        <span class="at">menu =</span> menu)</span>
<span id="cb32-64"><a href="#cb32-64" tabindex="-1"></a></span>
<span id="cb32-65"><a href="#cb32-65" tabindex="-1"></a>    <span class="co"># --- EPIDEMIC MODEL RUNS BASED ON OVERLAY POSITIONS ---</span></span>
<span id="cb32-66"><a href="#cb32-66" tabindex="-1"></a></span>
<span id="cb32-67"><a href="#cb32-67" tabindex="-1"></a>    <span class="co"># Model run function</span></span>
<span id="cb32-68"><a href="#cb32-68" tabindex="-1"></a>    run_model <span class="ot">&lt;-</span> <span class="cf">function</span>(...)</span>
<span id="cb32-69"><a href="#cb32-69" tabindex="-1"></a>    {</span>
<span id="cb32-70"><a href="#cb32-70" tabindex="-1"></a>        <span class="co"># Transform parameters</span></span>
<span id="cb32-71"><a href="#cb32-71" tabindex="-1"></a>        I0 <span class="ot">&lt;-</span> input<span class="sc">$</span>init_infec <span class="sc">/</span> <span class="dv">100</span>;</span>
<span id="cb32-72"><a href="#cb32-72" tabindex="-1"></a>        duration <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(input<span class="sc">$</span>date_range[<span class="dv">2</span>] <span class="sc">-</span> input<span class="sc">$</span>date_range[<span class="dv">1</span>])</span>
<span id="cb32-73"><a href="#cb32-73" tabindex="-1"></a>        infec_rate <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> input<span class="sc">$</span>latent_pd</span>
<span id="cb32-74"><a href="#cb32-74" tabindex="-1"></a>        recov_rate <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> input<span class="sc">$</span>infec_pd</span>
<span id="cb32-75"><a href="#cb32-75" tabindex="-1"></a>        trans_rate <span class="ot">&lt;-</span> input<span class="sc">$</span>R0 <span class="sc">*</span> recov_rate</span>
<span id="cb32-76"><a href="#cb32-76" tabindex="-1"></a></span>
<span id="cb32-77"><a href="#cb32-77" tabindex="-1"></a>        <span class="co"># Build population</span></span>
<span id="cb32-78"><a href="#cb32-78" tabindex="-1"></a>        pop <span class="ot">&lt;-</span> <span class="fu">population</span>(</span>
<span id="cb32-79"><a href="#cb32-79" tabindex="-1"></a>            <span class="at">name =</span> <span class="st">&quot;Utopia&quot;</span>,</span>
<span id="cb32-80"><a href="#cb32-80" tabindex="-1"></a>            <span class="at">contact_matrix =</span> <span class="fu">matrix</span>(<span class="dv">1</span>),</span>
<span id="cb32-81"><a href="#cb32-81" tabindex="-1"></a>            <span class="at">demography_vector =</span> input<span class="sc">$</span>pop_size <span class="sc">*</span> <span class="dv">1000000</span>,</span>
<span id="cb32-82"><a href="#cb32-82" tabindex="-1"></a>            <span class="at">initial_conditions =</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span> <span class="sc">-</span> I0, <span class="dv">0</span>, I0, <span class="dv">0</span>, <span class="dv">0</span>), <span class="at">nrow =</span> <span class="dv">1</span>)</span>
<span id="cb32-83"><a href="#cb32-83" tabindex="-1"></a>        )</span>
<span id="cb32-84"><a href="#cb32-84" tabindex="-1"></a></span>
<span id="cb32-85"><a href="#cb32-85" tabindex="-1"></a>        <span class="co"># Run model (with additional parameters from ...)</span></span>
<span id="cb32-86"><a href="#cb32-86" tabindex="-1"></a>        results <span class="ot">&lt;-</span> <span class="fu">model_default</span>(pop, <span class="at">transmission_rate =</span> trans_rate,</span>
<span id="cb32-87"><a href="#cb32-87" tabindex="-1"></a>            <span class="at">infectiousness_rate =</span> infec_rate, <span class="at">recovery_rate =</span> recov_rate,</span>
<span id="cb32-88"><a href="#cb32-88" tabindex="-1"></a>            <span class="at">time_end =</span> duration, ...)</span>
<span id="cb32-89"><a href="#cb32-89" tabindex="-1"></a></span>
<span id="cb32-90"><a href="#cb32-90" tabindex="-1"></a>        <span class="co"># Transform results -- construct date and only return infection prevalence</span></span>
<span id="cb32-91"><a href="#cb32-91" tabindex="-1"></a>        results<span class="sc">$</span>date <span class="ot">&lt;-</span> results<span class="sc">$</span>time <span class="sc">+</span> input<span class="sc">$</span>date_range[<span class="dv">1</span>]</span>
<span id="cb32-92"><a href="#cb32-92" tabindex="-1"></a>        results <span class="ot">&lt;-</span> results[results<span class="sc">$</span>compartment <span class="sc">==</span> <span class="st">&quot;infectious&quot;</span>, ]</span>
<span id="cb32-93"><a href="#cb32-93" tabindex="-1"></a>        <span class="fu">return</span> (results)</span>
<span id="cb32-94"><a href="#cb32-94" tabindex="-1"></a>    }</span>
<span id="cb32-95"><a href="#cb32-95" tabindex="-1"></a></span>
<span id="cb32-96"><a href="#cb32-96" tabindex="-1"></a>    <span class="co"># Unmitigated epidemic</span></span>
<span id="cb32-97"><a href="#cb32-97" tabindex="-1"></a>    epi_unmitigated <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb32-98"><a href="#cb32-98" tabindex="-1"></a>        <span class="fu">run_model</span>()</span>
<span id="cb32-99"><a href="#cb32-99" tabindex="-1"></a>    })</span>
<span id="cb32-100"><a href="#cb32-100" tabindex="-1"></a></span>
<span id="cb32-101"><a href="#cb32-101" tabindex="-1"></a>    <span class="co"># Mitigated epidemic</span></span>
<span id="cb32-102"><a href="#cb32-102" tabindex="-1"></a>    epi_mitigated <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb32-103"><a href="#cb32-103" tabindex="-1"></a>        <span class="co"># Create interventions</span></span>
<span id="cb32-104"><a href="#cb32-104" tabindex="-1"></a>        tx_int <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb32-105"><a href="#cb32-105" tabindex="-1"></a>        vax <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb32-106"><a href="#cb32-106" tabindex="-1"></a>        <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">which</span>(ov<span class="sc">$</span>active)) {</span>
<span id="cb32-107"><a href="#cb32-107" tabindex="-1"></a>            begin <span class="ot">&lt;-</span> ov<span class="sc">$</span>cx0[i] <span class="sc">-</span> <span class="fu">as.numeric</span>(input<span class="sc">$</span>date_range[<span class="dv">1</span>])</span>
<span id="cb32-108"><a href="#cb32-108" tabindex="-1"></a>            end <span class="ot">&lt;-</span> ov<span class="sc">$</span>cx1[i] <span class="sc">-</span> <span class="fu">as.numeric</span>(input<span class="sc">$</span>date_range[<span class="dv">1</span>])</span>
<span id="cb32-109"><a href="#cb32-109" tabindex="-1"></a>            <span class="cf">if</span> (ov<span class="sc">$</span>label[i] <span class="sc">==</span> <span class="st">&quot;Vaccination&quot;</span>) {</span>
<span id="cb32-110"><a href="#cb32-110" tabindex="-1"></a>                nu <span class="ot">&lt;-</span> ov<span class="sc">$</span>data<span class="sc">$</span>vac_rate[i] <span class="sc">*</span> <span class="dv">1000</span> <span class="sc">/</span> (input<span class="sc">$</span>pop_size <span class="sc">*</span> <span class="dv">1000000</span>)</span>
<span id="cb32-111"><a href="#cb32-111" tabindex="-1"></a>                <span class="cf">if</span> (<span class="fu">is.null</span>(vax)) {</span>
<span id="cb32-112"><a href="#cb32-112" tabindex="-1"></a>                    vax <span class="ot">&lt;-</span> <span class="fu">vaccination</span>(<span class="at">name =</span> <span class="fu">as.character</span>(i), <span class="at">nu =</span> <span class="fu">matrix</span>(nu),</span>
<span id="cb32-113"><a href="#cb32-113" tabindex="-1"></a>                        <span class="at">time_begin =</span> <span class="fu">matrix</span>(begin), <span class="at">time_end =</span> <span class="fu">matrix</span>(end))</span>
<span id="cb32-114"><a href="#cb32-114" tabindex="-1"></a>                } <span class="cf">else</span> {</span>
<span id="cb32-115"><a href="#cb32-115" tabindex="-1"></a>                    ov<span class="sc">$</span>active[i] <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb32-116"><a href="#cb32-116" tabindex="-1"></a>                }</span>
<span id="cb32-117"><a href="#cb32-117" tabindex="-1"></a>            } <span class="cf">else</span> <span class="cf">if</span> (ov<span class="sc">$</span>label[i] <span class="sc">==</span> <span class="st">&quot;Transmission&quot;</span>) {</span>
<span id="cb32-118"><a href="#cb32-118" tabindex="-1"></a>                reduc <span class="ot">&lt;-</span> ov<span class="sc">$</span>data<span class="sc">$</span>int_strength[i] <span class="sc">/</span> <span class="dv">100</span></span>
<span id="cb32-119"><a href="#cb32-119" tabindex="-1"></a>                tx_int[[<span class="fu">length</span>(tx_int) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">intervention</span>(<span class="at">name =</span> <span class="fu">as.character</span>(i),</span>
<span id="cb32-120"><a href="#cb32-120" tabindex="-1"></a>                    <span class="at">type =</span> <span class="st">&quot;rate&quot;</span>, <span class="at">time_begin =</span> <span class="fu">matrix</span>(begin), <span class="at">time_end =</span> <span class="fu">matrix</span>(end),</span>
<span id="cb32-121"><a href="#cb32-121" tabindex="-1"></a>                    <span class="at">reduction =</span> reduc)</span>
<span id="cb32-122"><a href="#cb32-122" tabindex="-1"></a>            }</span>
<span id="cb32-123"><a href="#cb32-123" tabindex="-1"></a>        }</span>
<span id="cb32-124"><a href="#cb32-124" tabindex="-1"></a></span>
<span id="cb32-125"><a href="#cb32-125" tabindex="-1"></a>        <span class="co"># Get mitigated model results</span></span>
<span id="cb32-126"><a href="#cb32-126" tabindex="-1"></a>        int <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb32-127"><a href="#cb32-127" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">length</span>(tx_int)) {</span>
<span id="cb32-128"><a href="#cb32-128" tabindex="-1"></a>            int[[<span class="st">&quot;transmission_rate&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">do.call</span>(c, tx_int)</span>
<span id="cb32-129"><a href="#cb32-129" tabindex="-1"></a>        }</span>
<span id="cb32-130"><a href="#cb32-130" tabindex="-1"></a>        <span class="fu">run_model</span>(<span class="at">vaccination =</span> vax,</span>
<span id="cb32-131"><a href="#cb32-131" tabindex="-1"></a>            <span class="at">intervention =</span> <span class="cf">if</span> (<span class="fu">length</span>(int)) int <span class="cf">else</span> <span class="cn">NULL</span>)</span>
<span id="cb32-132"><a href="#cb32-132" tabindex="-1"></a>    })</span>
<span id="cb32-133"><a href="#cb32-133" tabindex="-1"></a></span>
<span id="cb32-134"><a href="#cb32-134" tabindex="-1"></a>    <span class="co"># --- RENDERING OF EPI CURVES ---</span></span>
<span id="cb32-135"><a href="#cb32-135" tabindex="-1"></a></span>
<span id="cb32-136"><a href="#cb32-136" tabindex="-1"></a>    <span class="co"># Render plot and align overlays to current axis limits</span></span>
<span id="cb32-137"><a href="#cb32-137" tabindex="-1"></a>    output<span class="sc">$</span>display <span class="ot">&lt;-</span> <span class="fu">renderPlot</span>({</span>
<span id="cb32-138"><a href="#cb32-138" tabindex="-1"></a>        plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb32-139"><a href="#cb32-139" tabindex="-1"></a>            <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">epi_unmitigated</span>(),</span>
<span id="cb32-140"><a href="#cb32-140" tabindex="-1"></a>                <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value<span class="sc">/</span><span class="dv">1000</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb32-141"><a href="#cb32-141" tabindex="-1"></a>            <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">epi_mitigated</span>(),</span>
<span id="cb32-142"><a href="#cb32-142" tabindex="-1"></a>                <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value<span class="sc">/</span><span class="dv">1000</span>)) <span class="sc">+</span></span>
<span id="cb32-143"><a href="#cb32-143" tabindex="-1"></a>            <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">&quot;Infection prevalence (thousands)&quot;</span>) <span class="sc">+</span></span>
<span id="cb32-144"><a href="#cb32-144" tabindex="-1"></a>            <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="cn">NA</span>)</span>
<span id="cb32-145"><a href="#cb32-145" tabindex="-1"></a></span>
<span id="cb32-146"><a href="#cb32-146" tabindex="-1"></a>        <span class="fu">overlayBounds</span>(ov, plot, <span class="at">xlim =</span> <span class="fu">c</span>(input<span class="sc">$</span>date_range), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>))</span>
<span id="cb32-147"><a href="#cb32-147" tabindex="-1"></a>    })</span>
<span id="cb32-148"><a href="#cb32-148" tabindex="-1"></a>}</span>
<span id="cb32-149"><a href="#cb32-149" tabindex="-1"></a></span>
<span id="cb32-150"><a href="#cb32-150" tabindex="-1"></a><span class="co"># --- Run app ---</span></span>
<span id="cb32-151"><a href="#cb32-151" tabindex="-1"></a><span class="fu">shinyApp</span>(ui, server)</span></code></pre></div>
</details>
</div>
<div class="footnotes footnotes-end-of-document">
<hr />
<ol>
<li id="fn1"><p>Technically it’s not a list, it’s a
<code>shiny::reactiveValues()</code> object, but in many ways it behaves
like a normal R list.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
